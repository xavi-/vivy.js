<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
</head>
<body>
    <div .basic id="basic-test"></div>

    <div id="primitive-test"></div>

    <div id="basic-nested-test">
        <section .section>
            <h2 .title></h2>
            <div id="independent">not affected</div>
            <div>
                <p .paragraph></p>
            </div>
        </section>
        <div .deep.example1 id="deep1"></div>
        <div .deep.example2><span .deeper id="deep2"></span></div>
    </div>

    <div id="duplicates">
        <div .a><div .b><div .c id="ref1"></div></div></div>
        <div .a.b.c id="ref2"></div>
    </div>

    <div id="basic-array">
        <ol>
            <li .grocery_list[]></li>
        </ol>
    </div>

    <div id="nested-array">
        <li .grid[][]></li>
    </div>

    <div id="nested-object-array">
        <ol>
            <li .classes[].students[]></li>
        </ol>
    </div>

    <div id="complex-array">
        <div .first class="first">
            <ol>
                <li .[]><span .text></span></li>
            <ol>
            <div>Length: <strong .length></strong></div>
        </div>
        <p .second.0></p>
        <p .second.2></p>
    </div>

    <div id="input-basic">
        <input .input id="input">
        <input name="named" id="named">
        <textarea :assign-to=".assigned" name="not-used" id="assigned"></textarea>
    </div>

    <div id="input-radio">
        <label><input name="result" type="radio" value="fab"> fab</label>
        <label><input name="result" type="radio" value="rab"> rab</label>
        <label><input name="result" type="radio" value="bab"> bab</label>
    </div>

    <div id="input-checkbox">
        <label><input name="groupA" type="checkbox" value="woo"> woo</label>
        <label><input name="groupA" type="checkbox" value="poo"> poo</label>
        <label><input name="groupA" type="checkbox" value="chew"> chew</label>

        <label><input name="individualA" type="checkbox"> shew</label>
        <label><input name="individualB" type="checkbox" value="doo"> moo</label>
    </div>

    <div id="input-select">
        <select name="value">
            <option .options[] />
        </select>
    </div>

    <div id="input-multiselect">
        <select :assign-to="values" multiple>
            <option .options[] />
        </select>
    </div>

    <div id="input-non-string">
        <input name="color" type="color">
        <input name="number" type="number">
        <input name="date" type="date">
    </div>

    <div id="input-root-value">
        <select . multiple>
            <option>a</option>
            <option>b</option>
            <option>c</option>
        </select>
    </div>

    <div id="playground">
        <button @click=".clicked">button</button>
    </div>
<script type="module" src="./bop.js"></script>
<script type="module">
import { bop } from "./bop.js"

const playground = {
    clicked: (e, obj) => console.log("obj", obj),
};
const root = document.querySelector("#playground");
window.proxy = bop(root, playground);

function compareArrays(context, actual, expected) {
    if(expected.length !== actual?.length)
        throw new Error(`${context} -- Expected ${expected.length}, found ${actual?.length} items`);

    for(const [ idx, result ] of actual.entries()) {
        if(result === expected[idx]) continue;

        throw new Error(`${context} -- "${expected[idx]}" != "${result}"`);
    }
}

function compareValue(context, actual, expected) {
    if(actual === expected) return;
    if(expected instanceof Date && actual?.toString() == expected.toString()) return;

    throw new Error(`${context} -- "${expected}" != "${actual}"`);
}

async function runTest(selector, data, asserts) {
    const elem = document.querySelector(selector);
    const proxy = bop(elem, data);

    for(const [aIdx, assert] of asserts.entries()) {
        if(typeof assert === "function") {
            await assert(proxy, elem);
        } else if(assert.selector) {
            const { selector, expected } = assert;
            const selected = (selector == ".." ? elem : elem.querySelector(selector));
            if(selected == null) throw new Error(`Assert selector not found -- "${selector}"`);

            compareValue(`"${selector}:${aIdx}"`, selected.textContent, expected);
        } else if(assert.selectAll) {
            const { selectAll, expected } = assert;
            const selected = elem.querySelectorAll(selectAll);
            const results = [ ...selected ].map(s => s.textContent)

            compareArrays(`"${selector}:${aIdx}"`, results, expected);
        } else if(assert.valueFrom) {
            const { valueFrom, expected, isChecked } = assert;
            const selected = (valueFrom == ".." ? elem : elem.querySelector(valueFrom));
            if(selected == null) throw new Error(`Assert valueFrom not found -- "${valueFrom}"`);

            if(isChecked != null) {
                const actual = selected.checked;
                compareValue(`"${selector}:${aIdx}"`, actual, isChecked);
            } else if(selected.multiple) {
                const actual = [ ...selected.selectedOptions ].map(op => op.value);
                compareArrays(`"${selector}:${aIdx}"`, actual, expected);
            } else {
                const actual = selected.valueAsDate || selected.valueAsNumber || selected.value;
                compareValue(`"${selector}:${aIdx}"`, actual, expected);
            }
        } else if(assert.path) {
            const { path, expected } = assert;
            const parts = path.split(".").filter(p => p);

            let result = proxy;
            for(const part of parts) result = result?.[part];

            if(Array.isArray(expected)) { compareArrays(`"${path}:${aIdx}"`, result, expected); }
            else { compareValue(`"${path}:${aIdx}"`, result, expected); }
        } else {
            throw new Error("Unknown assert type, " + Object.keys(assert));
        }
    }
}
//*
runTest(
    "#basic-test",
    { basic: "hi" },
    [
        { selector: "..", expected: "hi" },

        (proxy) => proxy.basic = "hello",
        { selector: "..", expected: "hello" },

        (proxy) => proxy({}),
        { selector: "..", expected: "" },
    ]
);
runTest(
    "#primitive-test",
    "primitive",
    [
        { selector: "..", expected: "primitive" },

        (proxy) => proxy(),
        { selector: "..", expected: "" },
    ]
);
runTest(
    "#basic-nested-test",
    {
        section: {
            title: "title",
            paragraph: "I'm a deep paragraph",
        },
        deep: {
            example1: "deep",
            example2: { deeper: "deeper still" },
        },
    },
    [
        { selector: "#independent", expected: "not affected" },
        { selector: "h2", expected: "title" },
        { selector: "p", expected: "I'm a deep paragraph" },
        { selector: "#deep1", expected: "deep" },
        { selector: "#deep2", expected: "deeper still" },

        (proxy) => proxy.section.title = "title update",
        { selector: "h2", expected: "title update" },

        (proxy) => proxy.section = null,
        { selector: "#independent", expected: "not affected" },
        { selector: "h2", expected: "" },
        { selector: "p", expected: "" },

        (proxy) => proxy.deep.example1 = "example1 update",
        { selector: "#deep1", expected: "example1 update" },

        (proxy) => proxy.deep.example2.deeper = "example2 update",
        { selector: "#deep2", expected: "example2 update" },
    ]
);
runTest(
    "#duplicates",
    { a: { b: { c: "abc" } } },
    [
        { selector: "#ref1", expected: "abc" },
        { selector: "#ref2", expected: "abc" },

        (proxy) => proxy.a.b.c = "123",
        { selector: "#ref1", expected: "123" },
        { selector: "#ref2", expected: "123" },

        (proxy) => proxy.a(null),
        { selector: "#ref1", expected: "" },
        { selector: "#ref2", expected: "" },
    ]
);
runTest(
    "#basic-array",
    { grocery_list: [ "a", "b", "c" ] },
    [
        { selectAll: "li", expected: [ "a", "b", "c" ] },

        (proxy) => proxy.grocery_list.push("d"),
        { selectAll: "li", expected: [ "a", "b", "c", "d" ] },

        (proxy) => proxy(),
        { selectAll: "li", expected: [] },
    ]
);
runTest(
    "#nested-array",
    { grid: [ [ "blue", "green" ], [ "green", "blue" ] ] },
    [
        { selectAll: "li", expected: [ "blue", "green", "green", "blue" ] },

        (proxy) => proxy.grid.push([ "red", "purple" ]),
        { selectAll: "li", expected: [ "blue", "green", "green", "blue", "red", "purple" ] },

        (proxy) => proxy.grid[0].push("red"),
        { selectAll: "li", expected: [ "blue", "green", "red", "green", "blue", "red", "purple" ] },

        (proxy) => proxy.grid[2][1] = "cyan",
        { selectAll: "li", expected: [ "blue", "green", "red", "green", "blue", "red", "cyan" ] },

        (proxy) => proxy(),
        { selectAll: "li", expected: [] },
    ]
);
runTest(
    "#nested-object-array",
    { classes: [ { students: [ "alex", "blair" ] }, { students: [ "cory", "quinn" ] } ] },
    [
        { selectAll: "li", expected: [ "alex", "blair", "cory", "quinn" ] },

        (proxy) => proxy.classes[1] = { students: [ "daniel", "emerson" ] },
        { selectAll: "li", expected: [ "alex", "blair", "daniel", "emerson" ] },

        (proxy) => proxy(),
        { selectAll: "li", expected: [] },
    ]
);
runTest(
    "#complex-array",
    {
        first: [ { text: "a" }, { text: "b" }, { text: "c" } ],
        second: [ "alpha", "beta", "gamma" ]
    },
    [
        { selectAll: "li", expected: [ "a", "b", "c" ] },
        { selector: "strong", expected: "3" },
        { selectAll: "p", expected: [ "alpha", "gamma" ] },

        (proxy) => proxy({ first: [ { text: "d" } ], second: [ "one", "two", "three" ] }),
        { selectAll: "li", expected: [ "d" ] },
        { selector: "strong", expected: "1" },
        { selectAll: "p", expected: [ "one", "three" ] },

        (proxy) => proxy(),
        { selectAll: "li", expected: [] },
        { selector: "strong", expected: "" },
        { selectAll: "p", expected: [ "", "" ] },
    ]
);
runTest(
    "#input-basic",
    {
        input: "hi",
        named: "hey",
        assigned: "hello",
    },
    [
        { valueFrom: "#input", expected: "hi" },
        { valueFrom: "#named", expected: "hey" },
        { valueFrom: "#assigned", expected: "hello" },

        (proxy) => proxy.input = "ok",
        { valueFrom: "#input", expected: "ok" },

        (proxy) => proxy.named = "ok",
        { valueFrom: "#named", expected: "ok" },

        (proxy) => proxy.assigned = "ok",
        { valueFrom: "#assigned", expected: "ok" },

        (_, elem) => {
            const input = elem.querySelector("#input");
            input.value = "poop";
            input.dispatchEvent(new Event("change"))
        },
        { path: "input", expected: "poop" },

        (_, elem) => {
            const named = elem.querySelector("#named");
            named.value = "poop";
            named.dispatchEvent(new Event("change"))
        },
        { path: "named", expected: "poop" },

        (_, elem) => {
            const assigned = elem.querySelector("#assigned");
            assigned.value = "poop";
            assigned.dispatchEvent(new Event("change"))
        },
        { path: "assigned", expected: "poop" },
    ]
);
runTest(
    "#input-radio",
    { result: "rab" },
    [
        { valueFrom: "[value=fab]", isChecked: false },
        { valueFrom: "[value=rab]", isChecked: true },
        { valueFrom: "[value=bab]", isChecked: false },

        (proxy) => proxy.result = "fab",
        { valueFrom: "[value=fab]", isChecked: true },
        { valueFrom: "[value=rab]", isChecked: false },
        { valueFrom: "[value=bab]", isChecked: false },

        (_, elem) => {
            const input = elem.querySelector("[value=bab]");
            input.checked = true;
            input.dispatchEvent(new Event("change"))
        },
        { path: "result", expected: "bab" },
    ]
);
runTest(
    "#input-checkbox",
    { groupA: null, individualA: false, individualB: null },
    [
        { valueFrom: "[value=woo]", isChecked: false },
        { valueFrom: "[value=poo]", isChecked: false },
        { valueFrom: "[value=chew]", isChecked: false },
        { valueFrom: "[name=individualA]", isChecked: false },
        { valueFrom: "[name=individualB]", isChecked: false },

        (proxy) => proxy.individualA = true,
        { valueFrom: "[name=individualA]", isChecked: true },

        (_, elem) => {
            let input = elem.querySelector("[value=woo]");
            input.checked = true;
            input.dispatchEvent(new Event("change"));

            input = elem.querySelector("[value=poo]");
            input.checked = true;
            input.dispatchEvent(new Event("change"))
        },
        { path: "groupA", expected: [ "woo", "poo" ] },

        (proxy) => proxy.groupA = [],
        { valueFrom: "[value=woo]", isChecked: false },
        { valueFrom: "[value=poo]", isChecked: false },
        { valueFrom: "[value=chew]", isChecked: false },

        (_, elem) => {
            let input = elem.querySelector("[value=doo]");
            input.checked = true;
            input.dispatchEvent(new Event("change"));
        },
        { path: "individualB", expected: "doo" },
    ]
);
runTest(
    "#input-select",
    { value: null, options: [ "a", "b", "c", "d" ] },
    [
        (proxy) => proxy.value = "d",
        { valueFrom: "select", expected: "d" },

        (_, elem) => {
            let input = elem.querySelector("select");
            input.children[1].selected = true;
            input.dispatchEvent(new Event("change"));
        },
        { path: "value", expected: "b" },

        (proxy) => proxy.value = "a",
        { valueFrom: "select", expected: "a" },
    ]
);
runTest(
    "#input-multiselect",
    { values: null, options: [ "a", "b", "c", "d" ] },
    [
        (proxy) => proxy.values = [ "a", "d" ],
        { valueFrom: "select", expected: [ "a", "d" ] },

        (_, elem) => {
            let input = elem.querySelector("select");
            input.children[1].selected = true;
            input.dispatchEvent(new Event("change"));
        },
        { path: "values", expected: [ "a", "b", "d" ] },

        (_, elem) => {
            let input = elem.querySelector("select");
            input.children[0].selected = false;
            input.dispatchEvent(new Event("change"));
        },
        { path: "values", expected: [ "b", "d" ] },

        (proxy) => proxy.values = "a",
        { valueFrom: "select", expected: "a" },
    ]
);
runTest(
    "#input-non-string",
    { color: "#ffddff", number: 18, date: new Date("1995-12-17") },
    [
        { valueFrom: "[name=color]", expected: "#ffddff" },
        (_, elem) => {
            let input = elem.querySelector("[name=color]");
            input.value = "#aaddff";
            input.dispatchEvent(new Event("change"));
        },
        { path: "color", expected: "#aaddff" },

        (proxy) => proxy.color = "#ddeedd",
        { valueFrom: "[name=color]", expected: "#ddeedd" },

        { valueFrom: "[name=number]", expected: 18 },
        (_, elem) => {
            let input = elem.querySelector("[name=number]");
            input.valueAsNumber = 22;
            input.dispatchEvent(new Event("change"));
        },
        { path: "number", expected: 22 },

        (proxy) => proxy.number = 28,
        { valueFrom: "[name=number]", expected: 28 },

        { valueFrom: "[name=date]", expected: new Date("1995-12-17") },
        (_, elem) => {
            let input = elem.querySelector("[name=date]");
            input.valueAsDate = new Date("1994-11-16");
            input.dispatchEvent(new Event("change"));
        },
        { path: "date", expected: new Date("1994-11-16") },

        (proxy) => proxy.date = new Date("1993-10-15"),
        { valueFrom: "[name=date]", expected: new Date("1993-10-15") },
    ]
);
runTest(
    "#input-root-value",
    [ "a" ],
    [
        { valueFrom: "select", expected: [ "a" ] },
        (_, elem) => {
            let input = elem.querySelector("select");
            input.children[1].selected = true;
            input.dispatchEvent(new Event("change"));
        },
        { path: ".", expected: [ "a", "b" ] },

        (proxy) => proxy.shift(),
        { valueFrom: "select", expected: [ "b" ] },
    ]
);
//*/
</script>
</body>
</html>
