<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">

<script src="./vivy.js"></script>
<script>
function compareArrays(context, actual, expected) {
    if(expected.length !== actual?.length)
        throw new Error(`${context} -- Expected ${expected.length}, found ${actual?.length} items`);

    for(const [ idx, result ] of actual.entries()) {
        if(compareValue(context, result, expected[idx])) continue;

        throw new Error(`${context} -- "${expected[idx]}" != "${result}"`);
    }
}

function compareValue(context, actual, expected) {
    if(actual === expected) return true;
    if(typeof expected === 'string' && actual?.trim() == expected) return true;
    if(expected instanceof Date && actual?.toString() == expected.toString()) return true;
    if(expected == null && actual == null) return true;

    throw new Error(`${context} -- "${expected}" != "${actual}"`);
}

async function runTest(selector, data, asserts) {
    const elem = document.querySelector(selector);
    const proxy = vivy(elem, data);

    for(const [aIdx, assert] of asserts.entries()) {
        if(typeof assert === "function") {
            await assert(proxy, elem);
        } else if(assert.attr) {
            const { selector, attr, expected } = assert;

            const selected = (selector == ".." ? elem : elem.querySelector(selector));
            if(selected == null) throw new Error(`Assert selector not found -- "${selector}"`);

            const value = selected.attributes[attr]?.value;
            compareValue(`"${selector}[${attr}]:${aIdx}"`, value, expected);
        } else if(assert.selector) {
            const { selector, expected } = assert;
            const selected = (selector == ".." ? elem : elem.querySelector(selector));
            if(expected == null && selected == null) continue;
            if(selected == null) throw new Error(`Assert selector not found -- "${selector}"`);

            compareValue(`"${selector}:${aIdx}"`, selected.textContent, expected);
        } else if(assert.selectAll) {
            const { selectAll, expected } = assert;
            const selected = elem.querySelectorAll(selectAll);
            const results = [ ...selected ].map(s => s.textContent)

            compareArrays(`"${selector}:${aIdx}"`, results, expected);
        } else if(assert.valueFrom) {
            const { valueFrom, expected, isChecked } = assert;
            const selected = (valueFrom == ".." ? elem : elem.querySelector(valueFrom));
            if(selected == null) throw new Error(`Assert valueFrom not found -- "${valueFrom}"`);

            if(isChecked != null) {
                const actual = selected.checked;
                compareValue(`"${selector}:${aIdx}"`, actual, isChecked);
            } else if(selected.multiple) {
                const actual = [ ...selected.selectedOptions ].map(op => op.value);
                compareArrays(`"${selector}:${aIdx}"`, actual, expected);
            } else {
                const actual = selected.valueAsDate || selected.valueAsNumber || selected.value;
                compareValue(`"${selector}:${aIdx}"`, actual, expected);
            }
        } else if(assert.path) {
            const { path, expected } = assert;
            const parts = path.split(".").filter(p => p);

            let result = proxy;
            for(const part of parts) result = result?.[part];

            if(Array.isArray(expected)) { compareArrays(`"${path}:${aIdx}"`, result, expected); }
            else { compareValue(`"${path}:${aIdx}"`, result, expected); }
        } else {
            throw new Error("Unknown assert type, " + Object.keys(assert));
        }
    }
}
</script>
</head>
<body>

<div .basic id="basic-test"></div>
<script>
runTest(
    "#basic-test",
    { basic: "hi" },
    [
        { selector: "..", expected: "hi" },

        (proxy) => proxy.basic = "hello",
        { selector: "..", expected: "hello" },

        (proxy) => proxy({}),
        { selector: "..", expected: "" },
    ]
);
</script>

<div :scope=".basic" id="basic-attr-test"></div>
<script>
runTest(
    "#basic-attr-test",
    { basic: "bye" },
    [
        { selector: "..", expected: "bye" },

        (proxy) => proxy.basic = "later",
        { selector: "..", expected: "later" },

        (proxy) => proxy(null),
        { selector: "..", expected: "" },
    ]
);
</script>

<div id="primitive-test"></div>
<script>
runTest(
    "#primitive-test",
    "primitive",
    [
        { selector: "..", expected: "primitive" },

        (proxy) => proxy(),
        { selector: "..", expected: "" },
    ]
);
</script>

<div id="primitive-overriding-children">
    <p .paragraph>
        <span>some <b>text</b></span>
        <span>more <i>text</i></span>
    </p>
</div>
<script>
runTest(
    "#primitive-overriding-children",
    { paragraph: "paragraph" },
    [ { selector: "p", expected: "paragraph" } ]
);
</script>

<div id="basic-nested-test">
    <section .section>
        <h2 .title></h2>
        <div id="independent">not affected</div>
        <div>
            <p .paragraph></p>
        </div>
    </section>
    <div .deep.example1 id="deep1"></div>
    <div .deep.example2 id="example2"><span .deeper id="deep2"></span></div>
</div>
<script>
runTest(
    "#basic-nested-test",
    {
        section: {
            title: "title",
            paragraph: "I'm a deep paragraph",
        },
        deep: {
            example1: "deep",
            example2: { deeper: "deeper still" },
        },
    },
    [
        { selector: "#independent", expected: "not affected" },
        { selector: "h2", expected: "title" },
        { selector: "p", expected: "I'm a deep paragraph" },
        { selector: "#deep1", expected: "deep" },
        { selector: "#deep2", expected: "deeper still" },

        (proxy) => proxy.section.title = "title update",
        { selector: "h2", expected: "title update" },

        (proxy) => proxy.section = null,
        { selector: "#independent", expected: "not affected" },
        { selector: "h2", expected: "" },
        { selector: "p", expected: "" },

        (proxy) => proxy.deep.example1 = "example1 update",
        { selector: "#deep1", expected: "example1 update" },

        (proxy) => proxy.deep.example2.deeper = "example2 update",
        { selector: "#deep2", expected: "example2 update" },

        (proxy) => proxy.deep.example2 = "hi",
        { selector: "#example2", expected: "hi" },

        (proxy) => proxy.deep.example2 = { deeper: "back" },
        { selector: "#deep2", expected: "back" },
    ]
);
</script>

<div id="duplicates">
    <div .a id="ref3"><div .b><div .c id="ref1"></div></div></div>
    <div .a.b.c id="ref2"></div>
</div>
<script>
runTest(
    "#duplicates",
    { a: { b: { c: "abc" } } },
    [
        { selector: "#ref1", expected: "abc" },
        { selector: "#ref2", expected: "abc" },

        (proxy) => proxy.a.b.c = "123",
        { selector: "#ref1", expected: "123" },
        { selector: "#ref2", expected: "123" },

        (proxy) => proxy.a = "gone",
        { selector: "#ref2", expected: "" },
        { selector: "#ref3", expected: "gone" },

        (proxy) => proxy.a = { b: { c : "back" } },
        { selector: "#ref1", expected: "back" },
        { selector: "#ref2", expected: "back" },
        { selector: "#ref3", expected: "back" },

        (proxy) => proxy.a(null),
        { selector: "#ref1", expected: "" },
        { selector: "#ref2", expected: "" },
        { selector: "#ref3", expected: "" },
    ]
);
</script>

<div id="basic-array">
    <ol>
        <li .grocery_list[]></li>
    </ol>
</div>
<script>
runTest(
    "#basic-array",
    { grocery_list: [ "a", "b", "c" ] },
    [
        { selectAll: "li", expected: [ "a", "b", "c" ] },

        (proxy) => proxy.grocery_list.push("d"),
        { selectAll: "li", expected: [ "a", "b", "c", "d" ] },

        (proxy) => proxy(),
        { selectAll: "li", expected: [] },
    ]
);
</script>

<div id="nested-array">
    <li .grid[][]></li>
</div>
<script>
runTest(
    "#nested-array",
    { grid: [ [ "blue", "green" ], [ "green", "blue" ] ] },
    [
        { selectAll: "li", expected: [ "blue", "green", "green", "blue" ] },

        (proxy) => proxy.grid.push([ "red", "purple" ]),
        { selectAll: "li", expected: [ "blue", "green", "green", "blue", "red", "purple" ] },

        (proxy) => proxy.grid[0].push("red"),
        { selectAll: "li", expected: [ "blue", "green", "red", "green", "blue", "red", "purple" ] },

        (proxy) => proxy.grid[2][1] = "cyan",
        { selectAll: "li", expected: [ "blue", "green", "red", "green", "blue", "red", "cyan" ] },

        (proxy) => proxy(),
        { selectAll: "li", expected: [] },
    ]
);
</script>

<div id="nested-object-array">
    <ol>
        <li .classes[].students[]></li>
    </ol>
</div>
<script>
runTest(
    "#nested-object-array",
    { classes: [ { students: [ "alex", "blair" ] }, { students: [ "cory", "quinn" ] } ] },
    [
        { selectAll: "li", expected: [ "alex", "blair", "cory", "quinn" ] },

        (proxy) => proxy.classes[1] = { students: [ "daniel", "emerson" ] },
        { selectAll: "li", expected: [ "alex", "blair", "daniel", "emerson" ] },

        (proxy) => proxy(),
        { selectAll: "li", expected: [] },
    ]
);
</script>

<div id="complex-array">
    <div .first class="first">
        <ol>
            <li .[]><span .text></span></li>
        <ol>
        <div>Length: <strong .length></strong></div>
    </div>
    <p .second.0></p>
    <p .second.2></p>
</div>
<script>
runTest(
    "#complex-array",
    {
        first: [ { text: "a" }, { text: "b" }, { text: "c" } ],
        second: [ "alpha", "beta", "gamma" ]
    },
    [
        { selectAll: "li", expected: [ "a", "b", "c" ] },
        { selector: "strong", expected: "3" },
        { selectAll: "p", expected: [ "alpha", "gamma" ] },

        (proxy) => proxy({ first: [ { text: "d" } ], second: [ "one", "two", "three" ] }),
        { selectAll: "li", expected: [ "d" ] },
        { selector: "strong", expected: "1" },
        { selectAll: "p", expected: [ "one", "three" ] },

        (proxy) => proxy(),
        { selectAll: "li", expected: [] },
        { selector: "strong", expected: "" },
        { selectAll: "p", expected: [ "", "" ] },
    ]
);
</script>

<div id="input-basic">
    <input .input id="input">
    <input name="named" id="named">
    <input id="value" value.=".value">
    <textarea :assign-to=".assigned" name="not-used" id="assigned"></textarea>
</div>
<script>
runTest(
    "#input-basic",
    {
        input: "hi",
        named: "hey",
        value: "howdy",
        assigned: "hello",
    },
    [
        { valueFrom: "#input", expected: "hi" },
        { valueFrom: "#named", expected: "hey" },
        { valueFrom: "#value", expected: "howdy" },
        { valueFrom: "#assigned", expected: "hello" },

        (proxy) => proxy.input = "ok",
        { valueFrom: "#input", expected: "ok" },

        (proxy) => proxy.named = "ok",
        { valueFrom: "#named", expected: "ok" },

        (proxy) => proxy.value = "ok",
        { valueFrom: "#value", expected: "ok" },

        (proxy) => proxy.assigned = "ok",
        { valueFrom: "#assigned", expected: "ok" },

        (_, elem) => {
            const input = elem.querySelector("#input");
            input.value = "poop";
            input.dispatchEvent(new Event("change"))
        },
        { path: "input", expected: "poop" },

        (_, elem) => {
            const named = elem.querySelector("#named");
            named.value = "poop";
            named.dispatchEvent(new Event("change"))
        },
        { path: "named", expected: "poop" },

        (_, elem) => {
            const value = elem.querySelector("#value");
            value.value = "poop";
            value.dispatchEvent(new Event("change"))
        },
        { path: "value", expected: "poop" },

        (_, elem) => {
            const assigned = elem.querySelector("#assigned");
            assigned.value = "poop";
            assigned.dispatchEvent(new Event("change"))
        },
        { path: "assigned", expected: "poop" },
    ]
);
</script>

<div id="input-complex">
    <table>
        <tr .[]>
            <td .[]>
                <input :assign-to="." type="number" />
            </td>
        </tr>
    </table>
</div>
<script>
runTest(
    "#input-complex",
    [
        [ 1, 2, 3, 4 ],
        [ 5, 6, 7, 8 ]
    ],
    [
        { selectAll: "input", expected: [ "", "", "", "", "", "", "", "" ] },
        { valueFrom: "td:nth-child(2) > input", expected: 2 },

        (proxy) => proxy[0][1] = 12,
        { valueFrom: "td:nth-child(2) > input", expected: 12 },

        (_, elem) => {
            const input = elem.querySelector("td:nth-child(2) > input");
            input.value = 182;
            input.dispatchEvent(new Event("change"))
        },
        { path: ".0.1", expected: 182 },
    ]
);
</script>

<div id="input-radio">
    <label><input name="result" type="radio" value="fab"> fab</label>
    <label><input name="result" type="radio" value="rab"> rab</label>
    <label><input name="result" type="radio" value="bab"> bab</label>
</div>
<script>
runTest(
    "#input-radio",
    { result: "rab" },
    [
        { valueFrom: "[value=fab]", isChecked: false },
        { valueFrom: "[value=rab]", isChecked: true },
        { valueFrom: "[value=bab]", isChecked: false },

        (proxy) => proxy.result = "fab",
        { valueFrom: "[value=fab]", isChecked: true },
        { valueFrom: "[value=rab]", isChecked: false },
        { valueFrom: "[value=bab]", isChecked: false },

        (_, elem) => {
            const input = elem.querySelector("[value=bab]");
            input.checked = true;
            input.dispatchEvent(new Event("change"))
        },
        { path: "result", expected: "bab" },
    ]
);
</script>

<div id="input-checkbox">
    <label><input name="groupA" type="checkbox" value="woo"> woo</label>
    <label><input name="groupA" type="checkbox" value="poo"> poo</label>
    <label><input name="groupA" type="checkbox" value="chew"> chew</label>

    <label><input name="individualA" type="checkbox"> shew</label>
    <label><input name="individualB" type="checkbox" value="doo"> moo</label>
</div>
<script>
runTest(
    "#input-checkbox",
    { groupA: null, individualA: false, individualB: null },
    [
        { valueFrom: "[value=woo]", isChecked: false },
        { valueFrom: "[value=poo]", isChecked: false },
        { valueFrom: "[value=chew]", isChecked: false },
        { valueFrom: "[name=individualA]", isChecked: false },
        { valueFrom: "[name=individualB]", isChecked: false },

        (proxy) => proxy.individualA = true,
        { valueFrom: "[name=individualA]", isChecked: true },

        (_, elem) => {
            let input = elem.querySelector("[value=woo]");
            input.checked = true;
            input.dispatchEvent(new Event("change"));

            input = elem.querySelector("[value=poo]");
            input.checked = true;
            input.dispatchEvent(new Event("change"))
        },
        { path: "groupA", expected: [ "woo", "poo" ] },

        (proxy) => proxy.groupA = [],
        { valueFrom: "[value=woo]", isChecked: false },
        { valueFrom: "[value=poo]", isChecked: false },
        { valueFrom: "[value=chew]", isChecked: false },

        (_, elem) => {
            let input = elem.querySelector("[value=doo]");
            input.checked = true;
            input.dispatchEvent(new Event("change"));
        },
        { path: "individualB", expected: "doo" },
    ]
);
</script>

<div id="input-select">
    <select name="value">
        <option .options[] />
    </select>
</div>
<script>
runTest(
    "#input-select",
    { value: null, options: [ "a", "b", "c", "d" ] },
    [
        (proxy) => proxy.value = "d",
        { valueFrom: "select", expected: "d" },

        (_, elem) => {
            let input = elem.querySelector("select");
            input.children[1].selected = true;
            input.dispatchEvent(new Event("change"));
        },
        { path: "value", expected: "b" },

        (proxy) => proxy.value = "a",
        { valueFrom: "select", expected: "a" },
    ]
);
</script>

<div id="input-multiselect">
    <select :assign-to="values" multiple>
        <option .options[] />
    </select>
</div>
<script>
runTest(
    "#input-multiselect",
    { values: null, options: [ "a", "b", "c", "d" ] },
    [
        (proxy) => proxy.values = [ "a", "d" ],
        { valueFrom: "select", expected: [ "a", "d" ] },

        (_, elem) => {
            let input = elem.querySelector("select");
            input.children[1].selected = true;
            input.dispatchEvent(new Event("change"));
        },
        { path: "values", expected: [ "a", "b", "d" ] },

        (_, elem) => {
            let input = elem.querySelector("select");
            input.children[0].selected = false;
            input.dispatchEvent(new Event("change"));
        },
        { path: "values", expected: [ "b", "d" ] },

        (proxy) => proxy.values = "a",
        { valueFrom: "select", expected: "a" },
    ]
);
</script>

<div id="input-non-string">
    <input name="color" type="color">
    <input name="number" type="number">
    <input name="date" type="date">
</div>
<script>
runTest(
    "#input-non-string",
    { color: "#ffddff", number: 18, date: new Date("1995-12-17") },
    [
        { valueFrom: "[name=color]", expected: "#ffddff" },
        (_, elem) => {
            let input = elem.querySelector("[name=color]");
            input.value = "#aaddff";
            input.dispatchEvent(new Event("change"));
        },
        { path: "color", expected: "#aaddff" },

        (proxy) => proxy.color = "#ddeedd",
        { valueFrom: "[name=color]", expected: "#ddeedd" },

        { valueFrom: "[name=number]", expected: 18 },
        (_, elem) => {
            let input = elem.querySelector("[name=number]");
            input.valueAsNumber = 22;
            input.dispatchEvent(new Event("change"));
        },
        { path: "number", expected: 22 },

        (proxy) => proxy.number = 28,
        { valueFrom: "[name=number]", expected: 28 },

        { valueFrom: "[name=date]", expected: new Date("1995-12-17") },
        (_, elem) => {
            let input = elem.querySelector("[name=date]");
            input.valueAsDate = new Date("1994-11-16");
            input.dispatchEvent(new Event("change"));
        },
        { path: "date", expected: new Date("1994-11-16") },

        (proxy) => proxy.date = new Date("1993-10-15"),
        { valueFrom: "[name=date]", expected: new Date("1993-10-15") },
    ]
);
</script>

<div id="input-root-value">
    <select . multiple>
        <option>a</option>
        <option>b</option>
        <option>c</option>
    </select>
</div>
<script>
runTest(
    "#input-root-value",
    [ "a" ],
    [
        { valueFrom: "select", expected: [ "a" ] },
        (_, elem) => {
            let input = elem.querySelector("select");
            input.children[1].selected = true;
            input.dispatchEvent(new Event("change"));
        },
        { path: ".", expected: [ "a", "b" ] },

        (proxy) => proxy.shift(),
        { valueFrom: "select", expected: [ "b" ] },
    ]
);
</script>

<div id="attributes">
    <div id="attr" attr.=".attr" normal="okay"></div>
    <div id="num" num.=".number"></div>
    <div id="bool" bool.=".boolean"></div>
    <div id="is-null" is-null.=".is_nullish"></div>
    <div id="class" class.=".is_array"></div>
    <div id="style" style.=".is_object"></div>
</div>
<script>
runTest(
    "#attributes",
    {
        attr: "hello",
        number: 52,
        boolean: true,
        is_nullish: null,
        is_array: [ "a", "b", "c" ],
        is_object: { border: "1px solid blue", color: "green" },
    },
    [
        { selector: "#attr", attr: "attr", expected: "hello" },
        { selector: "#attr", attr: "normal", expected: "okay" },
        { selector: "#num", attr: "num", expected: "52" },
        { selector: "#bool", attr: "bool", expected: "" },
        { selector: "#is-null", attr: "is-null", expected: null },
        { selector: "#class", attr: "class", expected: "a b c" },
        { selector: "#style", attr: "style", expected: "border: 1px solid blue; color: green" },

        (proxy) => proxy.attr = "hi",
        { selector: "#attr", attr: "attr", expected: "hi" },

        (proxy) => proxy.number = 19,
        { selector: "#num", attr: "num", expected: "19" },

        (proxy) => proxy.boolean = false,
        { selector: "#bool", attr: "bool", expected: null },

        (proxy) => proxy.is_nullish = undefined,
        { selector: "#is-null", attr: "is-null", expected: null },

        (proxy) => proxy.is_array.pop(),
        { selector: "#class", attr: "class", expected: "a b" },

        (proxy) => proxy.is_array = [],
        { selector: "#class", attr: "class", expected: "" },

        (proxy) => proxy.is_object["background"] = "red",
        {
            selector: "#style",
            attr: "style",
            expected: "border: 1px solid blue; color: green; background: red"
        },

        (proxy) => proxy.is_object = {},
        { selector: "#style", attr: "style", expected: "" },
    ]
);
</script>

<button id="events" @click=".clicker" @mouseup=".upper" @mousemove=".mover">button</button>
<script>
runTest(
    "#events",
    {
        clicker: (_, obj) => obj.clickerCalls += 1,
        clickerCalls: 0,

        upper: (_, obj) => obj.upperCalls += 1,
        upperCalls: 0,

        mover: (_, obj) => obj.moverCalls += 1,
        moverCalls: 0,
    },
    [
        (_, elem) => elem.dispatchEvent(new Event("click")),
        { path: "clickerCalls", expected: 1 },

        (_, elem) => elem.dispatchEvent(new Event("mouseup")),
        { path: "upperCalls", expected: 1 },

        (_, elem) => elem.dispatchEvent(new Event("mousemove")),
        { path: "moverCalls", expected: 1 },

        (proxy) => proxy.clicker = (_, obj) => obj.clickerCalls += 10,
        (_, elem) => elem.dispatchEvent(new Event("click")),
        { path: "clickerCalls", expected: 11 },

        (proxy) => proxy.upper = (_, obj) => obj.upperCalls += 10,
        (_, elem) => elem.dispatchEvent(new Event("mouseup")),
        { path: "upperCalls", expected: 11 },

        (proxy) => proxy.mover = (_, obj) => obj.moverCalls += 10,
        (_, elem) => elem.dispatchEvent(new Event("mousemove")),
        { path: "moverCalls", expected: 11 },

        (proxy) => proxy.clicker = null,
        (_, elem) => elem.dispatchEvent(new Event("click")),
        { path: "clickerCalls", expected: 11 },

        (proxy) => proxy.upper = null,
        (_, elem) => elem.dispatchEvent(new Event("mouseup")),
        { path: "upperCalls", expected: 11 },

        (proxy) => proxy.mover = null,
        (_, elem) => elem.dispatchEvent(new Event("mousemove")),
        { path: "moverCalls", expected: 11 },
    ]
);
</script>

<div id="show-hide">
    <div id="show" :show-if=".show?">showing</div>
    <div id="neg-show" :show-if="!.show?">showing</div>

    <div id="inline-show" .show?>showing</div>
    <div id="inline-neg-show" !.show?>showing</div>

    <ul .arr.length?>
        <li .arr[]></li>
    </ul>

    <strong .!falsy?>all falsy?</strong>
</div>
<script>
runTest(
    "#show-hide",
    { show: true, arr: [ "a", "b", "c" ], falsy: 0 },
    [
        { selector: "#show", expected: "showing" },
        { selector: "#neg-show", expected: null },
        { selector: "#inline-show", expected: "showing" },
        { selector: "#inline-neg-show", expected: null },
        { selectAll: "li", expected: [ "a", "b", "c" ] },
        { selector: "strong", expected: null },

        (proxy) => proxy.show = false,
        { selector: "#show", expected: null },
        { selector: "#neg-show", expected: "showing" },
        { selector: "#inline-show", expected: null },
        { selector: "#inline-neg-show", expected: "showing" },

        (proxy) => proxy.arr.length = 0,
        { selector: "ul", expected: null },

        (proxy) => proxy.falsy = null,
        { selector: "strong", expected: null },

        (proxy) => proxy.falsy = "",
        { selector: "strong", expected: null },
    ]
);
</script>

<div id="root-reference">
    <div .obj>
        <em .text></em>
        <strong .$.text></strong>
        <span $.text></span>
        <button id="inner" @click="$.randomText">inner context</button>

        <input id="input1" $.input1>
        <input id="input2" :assign-to="$.input2">
        <div id="root-show" $.opt.show? class.="$.opt.classes">hello</div>
    </div>
    <button id="outer" @click=".randomText">outer context</button>
</div>
<script>
runTest(
    "#root-reference",
    {
        obj: { text: "hi" },
        text: "hello",
        randomText: (_, obj) => obj.text += " okay",

        input1: "input",
        input2: "another",

        opt: { show: false, classes: [ "a", "b" ] }
    },
    [
        { selector: "em", expected: "hi" },
        { selector: "strong", expected: "hello" },
        { selector: "span", expected: "hello" },
        { valueFrom: "#input1", expected: "input" },
        { valueFrom: "#input2", expected: "another" },
        { selector: "#root-show", expected: null },

        (_, elem) => elem.querySelector("#inner").dispatchEvent(new Event("click")),
        { selector: "em", expected: "hi okay" },
        { selector: "strong", expected: "hello" },
        { selector: "span", expected: "hello" },

        (_, elem) => elem.querySelector("#outer").dispatchEvent(new Event("click")),
        { selector: "em", expected: "hi okay" },
        { selector: "strong", expected: "hello okay" },
        { selector: "span", expected: "hello okay" },

        (_, elem) => {
            const input = elem.querySelector("#input1");
            input.value = "another input";
            input.dispatchEvent(new Event("change"))
        },
        { valueFrom: "#input1", expected: "another input" },

        (_, elem) => {
            const input = elem.querySelector("#input2");
            input.value = "another input";
            input.dispatchEvent(new Event("change"))
        },
        { valueFrom: "#input2", expected: "another input" },

        (proxy) => proxy.opt.show = true,
        { selector: "#root-show", expected: "hello" },
        { selector: "#root-show", attr: "class", expected: "a b" },

        (proxy) => proxy.opt.classes.push("c"),
        { selector: "#root-show", attr: "class", expected: "a b c" },
    ]
);
</script>

<div id="root-reference-arrays">
    <ul .lists[]>
        <li .[]>
            <span .text></span> <button @click="$.change">add</button>
        </li>
        <li $.base class="base"></li>
    </ul>
</div>
<script>
runTest(
    "#root-reference-arrays",
    {
        lists: [
            [ { text: "a" }, { text: "b" }, { text: "c" } ],
            [ { text: "x" }, { text: "y" }, { text: "z" } ],
        ],
        change: (_, obj) => obj.text += "!",
        base: "base",
    },
    [
        { selectAll: ".base", expected: [ "base", "base" ] },

        (_, elem) => [
            ...elem.querySelectorAll("button")
        ].forEach((elem, idx) => idx % 2 && elem.dispatchEvent(new Event("click"))),
        { selectAll: "li span", expected: [ "a", "b!", "c", "x!", "y", "z!" ] },

        // Test here to ensure bootstrapping issue
        (proxy) => proxy.base = "BASE",
        { selectAll: ".base", expected: [ "BASE", "BASE" ] },

        (proxy) => {
            proxy.lists.push([ { text: "new" } ]);
            proxy.base = "??";
        },
        { selectAll: ".base", expected: [ "??", "??", "??" ] },
    ]
);
</script>

<div id="template-basic">
    <div class="original">
        <p :template="original">
            original <span .text></span>
        </p>
        <t:original></t:original>
    </div>

    <div class="nested">
        <p :template="nested">
            <span>nested</span>
            <t:disappearing></t:disappearing>
        </p>
        <t:nested></t:nested>

        <vivy:template name="disappearing">
            hi <span .text></span>
        </vivy:template>
    </div>
</div>
<script>
runTest(
    "#template-basic",
    { text: "text" },
    [
        { selectAll: ".original p", expected: [ "original text", "original text" ] },
        { selectAll: ".nested p span", expected: [ "nested", "text", "nested", "text" ] },

        (proxy) => proxy.text = "text too",
        { selectAll: ".original p", expected: [ "original text too", "original text too" ] },
        { selectAll: ".nested p span", expected: [ "nested", "text too", "nested", "text too" ] },
    ]
);
</script>

<div id="template-complex">
    <ul>
        <li :template="tree">
            <span .name @dblclick="$.addChild"></span>
            <ul .children.length?>
                <t:tree .children[]></t:tree>
                <li><button @click="$.addChild">+</button></li>
            </ul>
        </li>
    </ul>
</div>
<script>
runTest(
    "#template-complex",
    {
        name: "root",
        children: [],
        addChild: (event, node) => node.children.push({
            name: `child${node.children.length + 1}`, children: []
        })
    },
    [
        { selectAll: "li", expected: [ "root" ] },
        { selectAll: "li li", expected: [] },

        (_, elem) => elem.querySelector("span").dispatchEvent(new Event("dblclick")),
        { selectAll: "li li span", expected: [ "child1" ] },
        { path: "children.0.name", expected: "child1" },

        (_, elem) => elem.querySelector("button").dispatchEvent(new Event("click")),
        { selectAll: "li li span", expected: [ "child1", "child2" ] },
        { path: "children.0.name", expected: "child1" },
        { path: "children.1.name", expected: "child2" },

        (_, elem) => elem.querySelector("li li span").dispatchEvent(new Event("dblclick")),
        { selectAll: "li li li span", expected: [ "child1" ] },
        { selectAll: "li li:nth-child(1) li span", expected: [ "child1" ] },
        { selectAll: "li li:nth-child(2) span", expected: [ "child2" ] },
        { path: "children.0.name", expected: "child1" },
        { path: "children.0.children.0.name", expected: "child1" },
        { path: "children.1.name", expected: "child2" },
    ]
);
</script>

<div id="show-if-bug">
    <div .prop_a.prop_b?><span .prop_a.prop_b></span></div>
</div>
<script>
runTest(
    "#show-if-bug",
    { prop_a: null },
    [
        { selector: "div span", expected: null },

        (proxy) => proxy.prop_a = { prop_b: "hello" },
        { selector: "div span", expected: "hello" },
    ]
);
</script>

<script>
(function jsonTest() {
    const tests = [
        { obj: null, json: "null" },
        { obj: 1, json: "1" },
        { obj: { a: [ 1, 2, 3, 4 ] }, json: `{"a":[1,2,3,4]}` },
        { obj: [ { a: 1 }, { a: 2 } ], json: `[{"a":1},{"a":2}]` },
        { obj: { toJSON: () => ({ a: 3 }), b: 4 }, json: `{"a":3}` },
    ]
    for(const { obj, json } of tests) {
        const actual = JSON.stringify(vivify(document.createElement("div"), obj));
        if(json != actual) {
            throw new Error(`JSON.stringify broken -- expected: '${json}', actual: '${actual}'`);
        }
    }
})();

(function sameValueTest() {
    const div = document.createElement("div");
    div.innerHTML = `<span .text class.="$.attr"></span><span .vals[]></span>`;

    const data = vivify(div, { text: "hello", attr: "okay", vals: [ 1, 2, 3 ] });

    const observer = new MutationObserver((mutations) => {
        throw new Error("Identical values should not mutate DOM");
    });
    observer.observe(div, { childList: true, attributes: true, subtree: true });

    data.text = "hello";
    data.attr = "okay";
    data.vals = data.vals;
    data.vals[0] = 1;
})();

(function nonHtmlValueArgTest() {
    let threwHelpfulError = false;
    try { vivy({}, {}); }
    catch(err) { threwHelpfulError = err.message.includes("HTMLElement"); }

    if(!threwHelpfulError) throw Error("Vivy accepted non HTMLElement argument");
})();
</script>
</body>
</html>
