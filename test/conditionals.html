<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<script src="../vivy.js"></script>
	<script src="./test_utils.js"></script>
	<style>
		.test-case { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
	</style>
</head>
<body>
	<h1>Conditional Binding Tests</h1>

	<!-- Basic Show/Hide -->
	<div id="show-hide-test" class="test-case">
		<h3>1. Show/Hide Directive</h3>
		<div id="show" :show-if=".show">showing</div>
		<div id="neg-show" :show-if="!.show">showing</div>

		<div id="inline-show" .show?>showing</div>
		<div id="inline-neg-show" !.show?>inline showing</div>
	</div>
	<script>
	runTest("Show/Hide Directive", document.getElementById("show-hide-test"), async (el) => {
		const isVisible = (selector) => el.querySelector(selector)?.parentNode;

		const app = vivy(el, { show: true });
		assert(isVisible("#show"), "Init Show Visible");
		assert(!isVisible("#neg-show"), "Init NegShow Hidden");
		assert(isVisible("#inline-show"), "Init InlineShow Visible");
		assert(!isVisible("#inline-neg-show"), "Init InlineNegShow Hidden");

		app.show = false;
		assert(!isVisible("#show"), "Update Show Hidden");
		assert(isVisible("#neg-show"), "Update NegShow Visible");
		assert(!isVisible("#inline-show"), "Update InlineShow Hidden");
		assert(isVisible("#inline-neg-show"), "Update InlineNegShow Visible");
	});
	</script>

	<!-- Show-If Bug Repro -->
	<div id="show-if-bug" class="test-case">
		<h3>2. Show-If Bug</h3>
		<div .prop_a.prop_b?><span .prop_a.prop_b></span></div>
	</div>
	<script>
	runTest("Show-If Bug", document.getElementById("show-if-bug"), async (el) => {
		const app = vivy(el, { prop_a: null });

		const div = el.querySelector("div > div");
		const isVisible = (elem) => elem?.parentNode;

		assert(!isVisible(div), "Init Hidden");

		app.prop_a = { prop_b: "hello" };
		const divVisible = el.querySelector("div > div");
		assert(isVisible(divVisible), "Update Visible");
		assert(divVisible.querySelector("span").textContent === "hello", "Content Rendered");
	});
	</script>

	<!-- Falsy Values -->
	<div id="falsy-values" class="test-case">
		<h3>3. Falsy Values</h3>
		<em .falsy?>all falsy?</em>
	</div>
	<script>
	runTest("Falsy Values", document.getElementById("falsy-values"), async (el) => {
		const isVisible = () => el.querySelector("em")?.parentNode;

		const app = vivy(el, {});
		assert(!isVisible(), "Init Hidden");

		const falsyValues = [ false, 0, -0, Number.NaN, "", undefined, null ];
		for (const value of falsyValues) {
			app.falsy = value;
			assert(!isVisible(), `${value} Falsy Hidden`);

			app.falsy = true; // reset
			assert(isVisible(), `True Falsy Visible after ${value}`);
		}
	});
	</script>

	<!-- Array tests -->
	<div id="array-tests" class="test-case">
		<h3>4. Array Tests</h3>
		<ul .arr.length?>
			<li .arr[]></li>
		</ul>
		<span :show-if="!.arr.length?">
			Empty Array
		</span>
	</div>
	<script>
	runTest("Array Tests", document.getElementById("array-tests"), async (el) => {
		const isVisible = (selector) => el.querySelector(selector)?.parentNode;

		const app = vivy(el, { arr: [ "a", "b", "c" ] });
		assert(isVisible("ul"), "Init Array");
		assert(!isVisible("span"), "Init Empty Array");

		app.arr = [];
		assert(!isVisible("ul"), "Clear Array");
		assert(isVisible("span"), "Empty Array");
	});
	</script>

	<!-- Multiple Show-If on Same Element -->
	<div id="multiple-show-if-test" class="test-case">
		<h3>5. Multiple Show-If Attributes</h3>
		<div .a? .b? id="multi-show-if">Content</div>
	</div>
	<script>
	runTest("Multiple Show-If Attributes", document.getElementById("multiple-show-if-test"), async (el) => {
		const warnings = [];
		const originalWarn = console.warn;
		console.warn = (...args) => warnings.push(args);

		try {
			vivy(el, { a: true, b: false });

			assert(warnings.some(w => w[0]?.includes("show-if")), "Warns about multiple show-if");
		} finally {
			console.warn = originalWarn;
		}
	});
	</script>

</body>
</html>
