<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<script src="../vivy.js"></script>
	<script src="./test_utils.js"></script>
	<style>
		.test-case { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
	</style>
</head>
<body>
	<h1>Array Binding Tests</h1>

	<!-- Basic Array -->
	<div id="basic-array" class="test-case">
		<h3>1. Basic Arrays</h3>
		<ol>
			<li .grocery_list[]></li>
		</ol>
	</div>
	<script>
	runTest("Basic Arrays", document.getElementById("basic-array"), async (el) => {
		const app = vivy(el, { grocery_list: [ "a", "b", "c" ] });
		const ol = el.querySelector("ol");

		const getItems = () => Array.from(ol.querySelectorAll("li")).map(ji => ji.textContent);

		assert(getItems().join(",") === "a,b,c", "Init List");

		app.grocery_list.push("d");
		assert(getItems().join(",") === "a,b,c,d", "Push Item");

		app.grocery_list = [];
		assert(getItems().length === 0, "Clear List");
	});
	</script>

	<!-- Nested Array -->
	<div id="nested-array" class="test-case">
		<h3>2. Nested Arrays</h3>
		<ul>
			<li .grid[][]></li>
		</ul>
	</div>
	<script>
	runTest("Nested Arrays", document.getElementById("nested-array"), async (el) => {
		const app = vivy(el, { grid: [ [ "blue", "green" ], [ "green", "blue" ] ] });
		const ul = el.querySelector("ul");

		const getItems = () => Array.from(ul.querySelectorAll("li")).map(ji => ji.textContent);

		// Flattened render
		assert(getItems().join(",") === "blue,green,green,blue", "Init Grid");

		app.grid.push([ "red", "purple" ]);
		assert(getItems().join(",") === "blue,green,green,blue,red,purple", "Push Row");

		app.grid[0].push("red");
		assert(getItems().join(",") === "blue,green,red,green,blue,red,purple", "Push Cell");

		app.grid[2][1] = "cyan";
		assert(getItems().join(",") === "blue,green,red,green,blue,red,cyan", "Update Cell");
	});
	</script>

	<!-- Array of Objects -->
	<div id="obj-array" class="test-case">
		<h3>3. Array of Objects</h3>
		<ul .classes[]>
			<li .students[]></li>
		</ul>
	</div>
	<script>
	runTest("Array of Objects", document.getElementById("obj-array"), async (el) => {
		const app = vivy(el, {
			classes: [
				{ students: [ "alex", "blair" ] },
				{ students: [ "cory", "quinn" ] }
			]
		});

		const getItems = () => Array.from(el.querySelectorAll("li")).map(ji => ji.textContent);

		assert(getItems().join(",") === "alex,blair,cory,quinn", "Init Obj Array");

		app.classes[1] = { students: [ "daniel", "emerson" ] };
		assert(getItems().join(",") === "alex,blair,daniel,emerson", "Replace Obj");
	});
	</script>

	<!-- Complex Array -->
	<div id="complex-array" class="test-case">
		<h3>4. Complex Array</h3>
		<div .first class="first">
			<ol>
				<li .[]><span .text></span></li>
			</ol>
			<div>Length: <strong .length></strong></div>
		</div>
		<p .second.0></p>
		<p .second.2></p>
	</div>
	<script>
	runTest("Complex Array", document.getElementById("complex-array"), async (el) => {
		const app = vivy(el, {
			first: [ { text: "a" }, { text: "b" }, { text: "c" } ],
			second: [ "alpha", "beta", "gamma" ]
		});

		const getItems = () => Array.from(el.querySelectorAll("ol li span")).map(s => s.textContent);
		const getProps = () => Array.from(el.querySelectorAll("p")).map(p => p.textContent);
		const length = el.querySelector("strong");

		assert(getItems().join(",") === "a,b,c", "Init List");
		assert(length.textContent === "3", "Init Length");
		assert(getProps()[0] === "alpha" && getProps()[1] === "gamma", "Init Props");

		app.first = [ { text: "d" } ];
		app.second = [ "one", "two", "three" ];

		assert(getItems().join(",") === "d", "Update List");
		assert(length.textContent === "1", "Update Length");
		assert(getProps()[0] === "one" && getProps()[1] === "three", "Update Props");
	});
	</script>

	<!-- JSON Serialization Test -->
	<div id="json-test" class="test-case">
		<h3>5. JSON Serialization</h3>
		<div></div>
	</div>
	<script>
	runTest("JSON Serialization", document.getElementById("json-test"), async () => {
		// Vivify creates the proxy without needing to be attached essentially for this test
		const tests = [
			{ obj: null, json: "null" },
			{ obj: 1, json: "1" },
			{ obj: { a: [ 1, 2, 3, 4 ] }, json: `{"a":[1,2,3,4]}` },
			{ obj: [ { a: 1 }, { a: 2 } ], json: `[{"a":1},{"a":2}]` },
			{ obj: { toJSON: () => ({ a: 3 }), b: 4 }, json: `{"a":3}` },
		];

		for(const { obj, json } of tests) {
			// We use a dummy element just to get the proxy
			const proxy = vivy(document.createElement("div"), obj);
			// proxy is the data proxy
			const actual = JSON.stringify(proxy);
			assert(actual === json, `JSON Mismatch: ${actual} vs ${json}`);
		}
	});
	</script>

	<!-- Root Array Test -->
	<div id="root-array-test" class="test-case">
	  <h3>6. Root Array</h3>
	  <ul>
		  <li $.items[]></li>
	  </ul>
	</div>
	<script>
	runTest("Root Array", document.getElementById("root-array-test"), async (el) => {
	  const app = vivy(el, { items: ["a", "b", "c"] });

	  const getItems = () => Array.from(el.querySelectorAll("li")).map(li => li.textContent);

	  assert(getItems().join(",") === "a,b,c", "Init Root Array");

	  app.items.push("d");
	  assert(getItems().join(",") === "a,b,c,d", "Push Root Array");
	});
	</script>

	<!-- Root Reference Arrays -->
	<div id="root-reference-arrays" class="test-case">
		<h3>7. Root Reference Arrays (Bootstrapping)</h3>
		<ul .lists[]>
			<li .[]>
				<span .text></span> <button @click="$.change">add</button>
			</li>
			<li $.base class="base"></li>
		</ul>
	</div>
	<script>
	runTest("Root Reference Arrays", document.getElementById("root-reference-arrays"), async (el) => {
		const app = vivy(el, {
			lists: [
				[ { text: "a" }, { text: "b" }, { text: "c" } ],
				[ { text: "x" }, { text: "y" }, { text: "z" } ],
			],
			change: (_, obj) => obj.text += "!",
			base: "base",
		});

		const getBase = () => Array.from(el.querySelectorAll(".base")).map(x => x.textContent);
		const getTexts = () => Array.from(el.querySelectorAll("li span")).map(x => x.textContent);

		// Check base is repeated for each list
		assert(getBase().join(",") === "base,base", "Init Base Repeated");
		assert(getTexts().length === 6, "Init Texts Count");

		// Click odd-indexed buttons (b, x, z) to trigger text += "!"
		const buttons = el.querySelectorAll("button");
		buttons.forEach((btn, idx) => {
			if (idx % 2 !== 0) btn.dispatchEvent(new Event("click"));
		});

		assert(getTexts().join(",") === "a,b!,c,x!,y,z!", "Buttons Triggered Updates");

		// Bootstrapping / Root Prop update
		app.base = "BASE";
		assert(getBase().join(",") === "BASE,BASE", "Root property update propagates");

		// Structural Change
		app.lists.push([ { text: "new" } ]);
		app.base = "??";

		// Now 3 lists. Base repeated 3 times.
		await wait(10);
		assert(getBase().join(",") === "??,??,??", "Structural + Root Prop Update");
		assert(getTexts().join(",") === "a,b!,c,x!,y,z!,new", "New List Added");
	});
	</script>

	<!-- Empty Array Initial State -->
	<div id="empty-array-test" class="test-case">
		<h3>8. Empty Array Initial State</h3>
		<ul>
			<li .items[]></li>
		</ul>
		<span .items.length></span>
	</div>
	<script>
	runTest("Empty Array Initial State", document.getElementById("empty-array-test"), async (el) => {
		const app = vivy(el, { items: [] });

		const ul = el.querySelector("ul");
		const lengthSpan = el.querySelector("span");

		assert(ul.querySelectorAll("li").length === 0, "No items rendered");
		assert(lengthSpan.textContent === "0", "Length shows 0");

		app.items.push("first");
		assert(ul.querySelectorAll("li").length === 1, "Item added");
		assert(lengthSpan.textContent === "1", "Length updated");
	});
	</script>

	<!-- Array Mutation Methods -->
	<div id="array-mutation" class="test-case">
		<h3>9. Array Mutation Methods</h3>
		<span .list.length></span>
	</div>
	<script>
	runTest("Array Mutation Methods", document.getElementById("array-mutation"), async (el) => {
		const app = vivy(el, { list: [] });
		const span = el.querySelector("span");

		assert(span.textContent === "0", "Init Length");

		// Call push on the proxy
		app.list.push("item");

		// Should trigger update
		assert(span.textContent === "1", `Length after push: ${span.textContent}`);

		// Call pop
		app.list.pop();
		assert(span.textContent === "0", `Length after pop: ${span.textContent}`);
	});
	</script>

	<!-- Multiple Lists -->
	<div id="multiple-lists" class="test-case">
		<h3>10. Multiple Lists (Same Source)</h3>
		<ul class="list-a">
			<li .tags[]></li>
		</ul>
		<div class="list-b">
			<span .tags[]></span>
		</div>
	</div>
	<script>
	runTest("Multiple Lists", document.getElementById("multiple-lists"), async (el) => {
		const app = vivy(el, { tags: ["a", "b"] });

		const listA = el.querySelector('.list-a');
		const listB = el.querySelector('.list-b');

		assert(listA.children.length === 2, "Init ListA length");
		assert(listB.children.length === 2, `Init ListB length (2 items + comment hidden)`);

		const itemsA = listA.querySelectorAll('li');
		const itemsB = listB.querySelectorAll('span');

		assert(itemsA.length === 2, "Init ItemsA count");
		assert(itemsB.length === 2, "Init ItemsB count");
		assert(itemsA[0].textContent === "a", "Init ItemA[0]");
		assert(itemsB[0].textContent === "a", "Init ItemB[0]");

		// Push item
		app.tags.push("c");

		// Need to re-query as elements are dynamic
		const newItemsA = listA.querySelectorAll('li');
		const newItemsB = listB.querySelectorAll('span');

		assert(newItemsA.length === 3, "Push ItemsA count");
		assert(newItemsB.length === 3, "Push ItemsB count");
		assert(newItemsA[2].textContent === "c", "Push ItemA[2]");
		assert(newItemsB[2].textContent === "c", "Push ItemB[2]");
	});
	</script>

	<!-- Very Large Array -->
	<div id="large-array-test" class="test-case">
		<h3>11. Very Large Array (1000+ items)</h3>
		<ul>
			<li .items[]></li>
		</ul>
		<span .items.length></span>
	</div>
	<script>
	runTest("Very Large Array", document.getElementById("large-array-test"), async (el) => {
		const largeArray = Array.from({ length: 1500 }, (_, i) => `item-${i}`);
		const app = vivy(el, { items: largeArray });

		const ul = el.querySelector("ul");
		const lengthSpan = el.querySelector("span");

		assert(ul.querySelectorAll("li").length === 1500, `Large array rendered: ${ul.querySelectorAll("li").length}`);
		assert(lengthSpan.textContent === "1500", `Length correct: ${lengthSpan.textContent}`);

		// Update middle item
		app.items[750] = "updated-750";
		const lis = ul.querySelectorAll("li");
		assert(lis[750].textContent === "updated-750", `Middle item updated: ${lis[750].textContent}`);

		// Push item
		app.items.push("new-item");
		assert(ul.querySelectorAll("li").length === 1501, `After push: ${ul.querySelectorAll("li").length}`);
	});
	</script>

	<!-- Array Reverse and Sort -->
	<div id="array-reverse-sort" class="test-case">
		<h3>32. Array Reverse and Sort</h3>
		<span .numbers[]></span>
	</div>
	<script>
	runTest("Array Reverse and Sort", document.getElementById("array-reverse-sort"), async (el) => {
		const app = vivy(el, { numbers: [3, 1, 4, 1, 5, 9, 2, 6] });

		const getNumbers = () => Array.from(el.querySelectorAll('span')).map(s => parseInt(s.textContent));

		assert(eq(getNumbers(), [ 3, 1, 4, 1, 5, 9, 2, 6 ]), `Init: ${getNumbers()}`);

		app.numbers.reverse();
		assert(eq(getNumbers(), [ 6, 2, 9, 5, 1, 4, 1, 3 ]), `Reverse: ${getNumbers()}`);

		app.numbers.sort((a, b) => a - b);
		assert(eq(getNumbers(), [ 1, 1, 2, 3, 4, 5, 6, 9 ]), `Sort: ${getNumbers()}`);

		app.numbers.fill(10);
		assert(eq(getNumbers(), [ 10, 10, 10, 10, 10, 10, 10, 10 ]), `Update After Sort: ${getNumbers()[0]}`);
	});
	</script>

	<!-- Multiple Array Bindings Same Data -->
	<div id="multiple-array-bindings-test" class="test-case">
		<h3>33. Multiple Array Bindings to Same Data</h3>
		<ul class="list1">
			<li .shared[]></li>
		</ul>
		<ul class="list2">
			<li .shared[]></li>
		</ul>
		<ul class="list3">
			<li .shared[]></li>
		</ul>
	</div>
	<script>
	runTest("Multiple Array Bindings Same Data", document.getElementById("multiple-array-bindings-test"), async (el) => {
		const app = vivy(el, { shared: [1, 2, 3] });

		const nums = (el) => Array.from(el.querySelectorAll("li")).map(li => parseInt(li.textContent));

		const list1 = el.querySelector(".list1");
		const list2 = el.querySelector(".list2");
		const list3 = el.querySelector(".list3");

		assert(eq(nums(list1), [ 1, 2, 3 ]), "List1 has 3 nums");
		assert(eq(nums(list2), [ 1, 2, 3 ]), "List2 has 3 nums");
		assert(eq(nums(list3), [ 1, 2, 3 ]), "List3 has 3 nums");

		app.shared.push(4);

		assert(eq(nums(list1), [ 1, 2, 3, 4 ]), "List1 has 4 nums");
		assert(eq(nums(list2), [ 1, 2, 3, 4 ]), "List2 has 4 nums");
		assert(eq(nums(list3), [ 1, 2, 3, 4 ]), "List3 has 4 nums");
	});
	</script>

</body>
</html>
