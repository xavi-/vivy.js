<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<script src="../vivy.js"></script>
	<script src="./test_utils.js"></script>
	<style>
		.test-case { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
	</style>
</head>
<body>
	<h1>Template Binding Tests</h1>

	<!-- Basic Template -->
	<div id="template-basic-test" class="test-case">
		<h3>1. Basic Template</h3>
		<div class="original">
			<p :template="original">
				original <span .text></span>
			</p>
			<t:original></t:original>
		</div>

		<div class="nested">
			<p :template="nested">
				<span>nested</span>
				<t:disappearing></t:disappearing>
			</p>
			<t:nested></t:nested>
			<vivy:template name="disappearing">
				hi <span .text></span>
			</vivy:template>
		</div>
	</div>
	<script>
	runTest("Basic Template", document.getElementById("template-basic-test"), async (el) => {
		const app = vivy(el, { text: "text" });

		const originalSpans = Array.from(el.querySelectorAll(".original p span"));
		const nestedSpans = Array.from(el.querySelectorAll(".nested p span"));

		// Original content + instantiated template
		assert(originalSpans.length === 2, "Original Spans Count");
		assert(originalSpans[0].textContent === "text", "Original Content");
		assert(originalSpans[1].textContent === "text", "Template Content");

		// Nested
		// "nested" (literal), "hi text" (from disappearing), duplicated
		// nestedSpans = [span(nested), span(text), span(nested), span(text)]
		assert(nestedSpans.length === 4, "Nested Spans Count");
		assert(nestedSpans[1].textContent === "text", "Nested Template Content");
		assert(nestedSpans[3].textContent === "text", "Nested Instance Content");

		app.text = "text too";
		assert(originalSpans[0].textContent === "text too", "Update Original");
		assert(originalSpans[1].textContent === "text too", "Update Instance");
	});
	</script>

	<!-- Recursive Template -->
	<div id="template-tree-test" class="test-case">
		<h3>2. Recursive Template (Tree)</h3>
		<ul>
			<li :template="tree">
				<span .name @dblclick="$.addChild"></span>
				<button @click="$.addChild">+</button>
				<ul .children.length?>
					<t:tree .children[]></t:tree>
				</ul>
			</li>
		</ul>
	</div>
	<script>
	runTest("Recursive Template", document.getElementById("template-tree-test"), async (el) => {
		const app = vivy(el, {
			name: "root",
			children: [],
			addChild: (_event, node) => node.children.push({
				name: `child${node.children.length + 1}`, children: []
			})
		});

		const getSpans = () => Array.from(el.querySelectorAll("span")).map(s => s.textContent);

		assert(getSpans().join(",") === "root", "Init Root");

		const rootBtn = el.querySelector("button");
		if (!rootBtn) throw new Error(`Root button not found in: ${el.innerHTML}`);
		rootBtn.dispatchEvent(new Event("click"));

		await wait(50); // Increased wait time

		const buttons = el.querySelectorAll("button");
		if (buttons.length < 2) {
			 console.error(`DEBUG Templates Recursive Fail. HTML: ${el.innerHTML}`);
			 throw new Error(`Expected at least 2 buttons, found ${buttons.length}`);
		}
		const child1Btn = buttons[1];
		child1Btn.dispatchEvent(new Event("click"));
		await wait(20);

		assert(getSpans().join(",") === "root,child1,child1", "Add Nested Child");

		assert(app.children.length === 1, "Root has 1 child");
		assert(app.children[0].name === "child1", "Child1 Name");
		assert(app.children[0].children.length === 1, "Child1 has 1 child");
	});
	</script>

	<!-- Template Scope -->
	<div id="template-scope-test" class="test-case">
		<h3>3. Template Scope</h3>
		<t:embed .info></t:embed>
		<vivy:template name="embed">
			Hello <span .name></span>
		</vivy:template>
	</div>
	<script>
	runTest("Template Scope", document.getElementById("template-scope-test"), async (el) => {
		const app = vivy(el, { info: { name: "emery" } });
		const span = el.querySelector("span");

		assert(span.textContent === "emery", "Init Scope");

		app.info.name = "bob";
		assert(span.textContent === "bob", "Update Scope");
	});
	</script>

	<!-- Shared State Bug (excessive templates) -->
	<div id="shared-state-test" class="test-case">
		<h3>4. Shared State Bug (Excessive Templates)</h3>
		<p>Checking if template usage limits or shared state cause issues across instances.</p>
		<div id="app1">
			<vivy:template name="t">x</vivy:template>
			<div id="container1"></div>
		</div>
		<div id="app2">
			<vivy:template name="t">x</vivy:template>
			<div id="container2"></div>
		</div>
	</div>
	<script>
	runTest("Shared State Bug", document.getElementById("shared-state-test"), async (testRoot) => {
		const container1 = testRoot.querySelector('#container1');
		const container2 = testRoot.querySelector('#container2');

		// Generate many template usages
		const count = 6000;
		const html = Array(count).fill('<t:t></t:t>').join('');
		container1.innerHTML = html;
		container2.innerHTML = html;

		console.log("Initializing App 1...");
		vivy(testRoot.querySelector('#app1'), {});
		console.log("App 1 initialized.");

		console.log("Initializing App 2...");
		vivy(testRoot.querySelector('#app2'), {});
		console.log("App 2 initialized.");

		// If we got here without error, it passed.
		// We can assert content length to be sure it rendered.
		assert(container1.textContent.length === count, "App 1 Rendered correctness");
		assert(container2.textContent.length === count, "App 2 Rendered correctness");
	});
	</script>
	<!-- Template Null Scope -->
	<div id="template-null-scope-test" class="test-case">
		<h3>5. Template Null Scope</h3>
		<div .parent :show-if=".">
			<t:embed-null .info :show-if="."></t:embed-null>
		</div>
		<vivy:template name="embed-null">
			<div>Hello <span .name></span></div>
		</vivy:template>
	</div>
	<script>
	runTest("Template Null Scope", document.getElementById("template-null-scope-test"), async (el) => {
		const app = vivy(el, { parent: null });

		assert(el.querySelector("div span") === null, "Init Null (Hidden)");

		app.parent = { info: { name: "emery" } };
		const span = el.querySelector("span");
		assert(span && span.textContent === "emery", "Update to valid scope");
	});
	</script>

	<!-- Template Nested Scope -->
	<div id="template-nested-scope-test" class="test-case">
		<h3>6. Template Nested Scope</h3>
		<div .parent>
			<t:embed1 .info :show-if="."></t:embed1>
		</div>
		<vivy:template name="embed1">
			<div .nested>
				Hello <span .name></span>
			</div>
		</vivy:template>
	</div>
	<script>
	runTest("Template Nested Scope", document.getElementById("template-nested-scope-test"), async (el) => {
		const app = vivy(el, { parent: null });

		assert(el.querySelector("span") === null, "Init Null");

		app.parent = { info: { nested: { name: "emery" } } };
		// Template binds .info.
		// Inside: <div .nested> -> sub-scope `nested`.
		// Inside: <span .name> -> `name`.
		// So info needs correct structure.
		// app.parent = { info: ... }
		// .info = { nested: { name: "emery" } }

		await wait(10);
		const span = el.querySelector("span");
		assert(span && span.textContent === "emery", "Deep Nested Scope");
	});
	</script>

</body>
</html>
