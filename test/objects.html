<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<script src="../vivy.js"></script>
	<script src="./test_utils.js"></script>
	<style>
		.test-case { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
	</style>
</head>
<body>
	<h1>Object Binding Tests</h1>

	<!-- Basic Test -->
	<div id="basic-test" class="test-case">
		<h3>1. Basic Text</h3>
		<div .basic></div>
	</div>
	<script>
	runTest("Basic Text Binding", document.getElementById("basic-test"), async (el) => {
		const app = vivy(el, { basic: "hi" });
		const div = el.querySelector("div");

		assert(div.textContent === "hi", `Init: ${div.textContent}`);

		app.basic = "hello";
		assert(div.textContent === "hello", `Update: ${div.textContent}`);

		app(null);
		assert(div.textContent === "", `Clear (null): ${div.textContent}`);

		app({});
		assert(div.textContent === "", `Clear (empty obj): ${div.textContent}`);
	});
	</script>

	<!-- Nested Object -->
	<div id="nested-test" class="test-case">
		<h3>2. Nested Object</h3>
		<section .section>
			<h2 .title></h2>
			<div id="independent">not affected</div>
			<div>
				<p .paragraph></p>
			</div>
		</section>
		<div .deep.example1 id="deep1"></div>
		<div .deep.example2 id="example2"><span .deeper id="deep2"></span></div>
	</div>
	<script>
	runTest("Nested Object", document.getElementById("nested-test"), async (el) => {
		const app = vivy(el, {
			section: {
				title: "title",
				paragraph: "I'm a deep paragraph",
			},
			deep: {
				example1: "deep",
				example2: { deeper: "deeper still" },
			},
		});

		const h2 = el.querySelector("h2");
		const p = el.querySelector("p");
		const deep1 = el.querySelector("#deep1");
		const deep2 = el.querySelector("#deep2");
		const example2 = el.querySelector("#example2");
		const independent = el.querySelector("#independent");

		assert(independent.textContent === "not affected", "Init Independent");
		assert(h2.textContent === "title", "Init H2");
		assert(p.textContent === "I'm a deep paragraph", "Init P");
		assert(deep1.textContent === "deep", "Init Deep1");
		assert(deep2.textContent === "deeper still", "Init Deep2");

		// Update
		app.section.title = "title update";
		assert(h2.textContent === "title update", "Update H2");

		app.deep.example1 = "example1 update";
		assert(deep1.textContent === "example1 update", "Update Deep1");

		app.deep.example2.deeper = "example2 update";
		assert(deep2.textContent === "example2 update", "Update Deep2");

		// Object replacement
		app.deep.example2 = "hi";
		assert(example2.textContent === "hi", "Replace Obj with String");

		// Restore
		app.deep.example2 = { deeper: "back" };
		assert(deep2.textContent === "back", "Restore Obj");

		// Nullify
		app.section = null;
		assert(h2.textContent === "", "Nullify Section H2");
		assert(p.textContent === "", "Nullify Section P");
		assert(independent.textContent === "not affected", "Nullify Indep");
	});
	</script>

	<!-- Duplicate References -->
	<div id="duplicates-test" class="test-case">
		<h3>3. Duplicate References</h3>
		<div .a id="ref3"><div .b><div .c id="ref1"></div></div></div>
		<div .a.b.c id="ref2"></div>
	</div>
	<script>
	runTest("Duplicate References", document.getElementById("duplicates-test"), async (el) => {
		const app = vivy(el, { a: { b: { c: "abc" } } });

		const ref1 = el.querySelector("#ref1");
		const ref2 = el.querySelector("#ref2");
		const ref3 = el.querySelector("#ref3");

		assert(ref1.textContent === "abc", "Init Ref1");
		assert(ref2.textContent === "abc", "Init Ref2");

		app.a.b.c = "123";
		assert(ref1.textContent === "123", "Update Ref1");
		assert(ref2.textContent === "123", "Update Ref2");

		app.a = "gone";
		assert(ref2.textContent === "", "Replace A (Ref2 gone)");
		assert(ref3.textContent === "gone", "Replace A (Ref3 val)");

		app.a = { b: { c : "back" } };
		assert(ref1.textContent === "back", "Restore A Ref1");
		assert(ref2.textContent === "back", "Restore A Ref2");
		assert(ref3.textContent === "back", "Restore A Ref3");
	});
	</script>

	<!-- Root Reference -->
	<div id="root-ref-test" class="test-case">
		<h3>4. Root References</h3>
		<div .obj>
			<em .text></em>
			<strong .$.text></strong>
			<span $.text></span>
			<button id="inner" @click="$.random_text">inner context</button>
		</div>
		<button id="outer" @click=".random_text">outer context</button>
	</div>
	<script>
	runTest("Root References", document.getElementById("root-ref-test"), async (el) => {
		vivy(el, {
			obj: { text: "hi" },
			text: "hello",
			random_text: (_, obj) => obj.text += " okay",
		});

		const em = el.querySelector("em");
		const strong = el.querySelector("strong");
		const span = el.querySelector("span");

		assert(em.textContent === "hi", "Init Em");
		assert(strong.textContent === "hello", "Init Strong");
		assert(span.textContent === "hello", "Init Span");

		// Event triggering root method
		el.querySelector("#inner").dispatchEvent(new Event("click"));
		// randomText appends " okay" to root.text
		assert(em.textContent === "hi okay", "Event Em Updated");
		assert(strong.textContent === "hello", "Event Strong Unchanged");
		assert(span.textContent === "hello", "Event Span Unchanged");

		el.querySelector("#outer").dispatchEvent(new Event("click"));
		assert(strong.textContent === "hello okay", "Event 2 Strong Updated");
	});
	</script>

	<!-- Multiple Text Bindings -->
	<div id="multiple-text-bindings" class="test-case">
		<h3>5. Multiple Text Bindings</h3>
		<span class="t1-a" .message></span>
		<div class="t1-b" .message></div>
		<p class="t1-c" .message></p>
	</div>
	<script>
	runTest("Multiple Text Bindings", document.getElementById("multiple-text-bindings"), async (el) => {
		const app = vivy(el, { message: "Initial" });

		const a = el.querySelector('.t1-a');
		const b = el.querySelector('.t1-b');
		const c = el.querySelector('.t1-c');

		// Check initial
		assert(a.textContent === "Initial", `Init A: ${a.textContent}`);
		assert(b.textContent === "Initial", `Init B: ${b.textContent}`);
		assert(c.textContent === "Initial", `Init C: ${c.textContent}`);

		// Update
		app.message = "Updated Value";

		assert(a.textContent === "Updated Value", `Update A: ${a.textContent}`);
		assert(b.textContent === "Updated Value", `Update B: ${b.textContent}`);
		assert(c.textContent === "Updated Value", `Update C: ${c.textContent}`);
	});
	</script>

	<!-- Nested Object Multi-Binding -->
	<div id="nested-object-multi-binding" class="test-case">
		<h3>6. Nested Object Multi-Binding</h3>
		<span class="t3-first" .user.first></span>
		<span class="t3-last" .user.last></span>
		<div class="t3-full">
			<span .user.first></span> <span .user.last></span>
		</div>
	</div>
	<script>
	runTest("Nested Object Multi-Binding", document.getElementById("nested-object-multi-binding"), async (el) => {
		const app = vivy(el, { user: { first: "John", last: "Doe" } });

		const first1 = el.querySelector('.t3-first');
		const last1 = el.querySelector('.t3-last');
		const first2 = el.querySelector('.t3-full span:nth-child(1)');

		assert(first1.textContent === "John", "Init First1");
		assert(first2.textContent === "John", "Init First2");

		// Update deep property
		app.user.first = "Jane";

		assert(first1.textContent === "Jane", "Update First1");
		assert(first2.textContent === "Jane", "Update First2");
		assert(last1.textContent === "Doe", "Last should be unchanged");

		// Replace entire object
		app.user = { first: "Bob", last: "Smith" };

		assert(first1.textContent === "Bob", "Replace First1");
		assert(last1.textContent === "Smith", "Replace Last1");
	});
	</script>

	<!-- Primitive to Object Upgrade -->
	<div id="prim-to-obj" class="test-case">
		<h3>7. Primitive to Object</h3>
		<div .obj>
			<span .name></span>
		</div>
	</div>
	<script>
	runTest("Primitive to Object", document.getElementById("prim-to-obj"), async (el) => {
		const app = vivy(el, { obj: "name" });
		const div = el.querySelector("div > div"); // .obj

		assert(div.textContent === "name", "Init Primitive");

		app.obj = { name: "NAME" };
		assert(el.querySelector("span").textContent === "NAME", "Upgrade to Object");
	});
	</script>

	<!-- Null to Object Upgrade -->
	<div id="null-to-obj" class="test-case">
		<h3>8. Null to Object</h3>
		<div .obj :show-if=".">
			<span .name></span>
		</div>
	</div>
	<script>
	runTest("Null to Object", document.getElementById("null-to-obj"), async (el) => {
		const app = vivy(el, {});

		// .obj might be hidden
		// In vivy, show-if usually hides/removes.

		app.obj = { name: "NAME" };
		const span = el.querySelector("span");
		assert(span && span.textContent === "NAME", "Upgrade from Null");
	});
	</script>

	<!-- Null to Nested Object -->
	<div id="null-to-nested-obj" class="test-case">
		<h3>9. Null to Nested Object</h3>
		<div .obj :show-if=".">
			<div .nested>
				<span .name></span>
			</div>
		</div>
	</div>
	<script>
	runTest("Null to Nested Object", document.getElementById("null-to-nested-obj"), async (el) => {
		const app = vivy(el, {});

		assert(el.querySelector("span") === null, "Init Null");

		app.obj = { nested: { name: "NAME" } };
		await wait(10);
		const span = el.querySelector("span");
		assert(span.textContent === "NAME", "Upgrade to Nested Object");
	});
	</script>

	<!-- Same Object, Different Paths -->
	<div id="same-obj-diff-paths" class="test-case">
		<h3>10. Same Object, Different Paths</h3>
		<span class="a-name" .a.name></span>
		<span class="b-name" .b.name></span>
	</div>
	<script>
	runTest("Same Object, Different Paths", document.getElementById('same-obj-diff-paths'), async (el) => {
		const obj = { name: "initial" };
		const app = vivy(el, { a: obj, b: obj });

		const aName = el.querySelector('.a-name');
		const bName = el.querySelector('.b-name');

		assert(aName.textContent === "initial", `Init A: ${aName.textContent}`);
		assert(bName.textContent === "initial", `Init B: ${bName.textContent}`);

		// Update via A
		app.a.name = "updated";

		assert(aName.textContent === "updated", `Update A: ${aName.textContent}`);
		// This is EXPECTED TO FAIL if my theory is correct
		assert(bName.textContent === "updated", `Update B (via shared obj): ${bName.textContent}`);
	});
	</script>

	<!-- Copying Object Check -->
	<div id="move-object" class="test-case">
		<h3>11. Copy Object Check</h3>
		<div .a>
			<span class="val" .val></span>
		</div>
		<div .b>
			<span class="val-b" .val></span>
		</div>
	</div>
	<script>
	runTest("Move Object Check", document.getElementById("move-object"), async (el) => {
		const obj = { val: "moved" };
		const app = vivy(el, { a: obj, b: { val: "initial" } });

		const valA = el.querySelector('.val');
		const valB = el.querySelector('.val-b');

		assert(valA.textContent === "moved", "Init A");

		// Move obj to b
		app.b = app.a;

		// Update val via A
		app.a.val = "changes";

		// B should update
		assert(valB.textContent === "changes", `B reflects changes: ${valB.textContent}`);
	});
	</script>

	<!-- Complex Scope Chains -->
	<div id="complex-scope-chains" class="test-case">
		<h3>12. Complex Scope Chains</h3>
		<div .level1>
			<span class="l1" .name></span>
			<div .level2>
				<span class="l2" .name></span>
				<span class="l2-root" $.global></span>
				<div .level3>
					<span class="l3" .name></span>
					<span class="l3-l1" $.level1.name></span>
				</div>
			</div>
		</div>
	</div>
	<script>
	runTest("Complex Scope Chains", document.getElementById("complex-scope-chains"), async (el) => {
		const app = vivy(el, {
			global: "root-val",
			level1: {
				name: "one",
				level2: {
					name: "two",
					level3: {
						name: "three"
					}
				}
			}
		});

		const l1 = el.querySelector(".l1");
		const l2 = el.querySelector(".l2");
		const l2root = el.querySelector(".l2-root");
		const l3 = el.querySelector(".l3");
		const l3l1 = el.querySelector(".l3-l1");

		assert(l1.textContent === "one", "L1 Name");
		assert(l2.textContent === "two", "L2 Name");
		assert(l2root.textContent === "root-val", "L2 Root Access");
		assert(l3.textContent === "three", "L3 Name");
		assert(l3l1.textContent === "one", "L3 Access to L1 Path");

		// Updates
		app.level1.name = "ONE";
		assert(l1.textContent === "ONE", "L1 Update");
		assert(l3l1.textContent === "ONE", "L3 reflected L1 Update");

		app.level1.level2.level3.name = "THREE";
		assert(l3.textContent === "THREE", "L3 Update");
	});
	</script>

	<!-- Circular Reference Test -->
	<div id="circular-ref-test" class="test-case">
		<h3>13. Circular Reference</h3>
		<div .obj>
			<span .val></span>
			<div class="self" .self>
				<span .val></span>
			</div>
		</div>
	</div>
	<script>
	runTest("Circular Reference", document.getElementById("circular-ref-test"), async (el) => {
		const obj = { val: "safe" };
		obj.self = obj; // Circular ref

		const app = vivy(el, { obj });
		const span = el.querySelector("span");

		assert(span.textContent === "safe", "Rendered despite circular ref");

		app.obj.val = "updated";
		assert(span.textContent === "updated", "Updates work with circular ref");

		assert(app.obj.self.val === "updated", "Access via self works");

		const selfSpan = el.querySelector(".self span");
		assert(selfSpan.textContent === "updated", "Updates work with circular ref");
	});
	</script>

	<!-- Very Deep Nesting (10+ levels) -->
	<div id="deep-nesting-test" class="test-case">
		<h3>14. Very Deep Nesting (10 levels)</h3>
		<div .l1>
			<div .l2>
				<div .l3>
					<div .l4>
						<div .l5>
							<div .l6>
								<div .l7>
									<div .l8>
										<div .l9>
											<div .l10>
												<span .value></span>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
	runTest("Very Deep Nesting", document.getElementById("deep-nesting-test"), async (el) => {
		const deepData = {
			l1: { l2: { l3: { l4: { l5: { l6: { l7: { l8: { l9: { l10: { value: "deep" } } } } } } } } } }
		};

		const app = vivy(el, deepData);
		const span = el.querySelector("span");

		assert(span.textContent === "deep", `Init deep value: ${span.textContent}`);

		// Update deepest value
		app.l1.l2.l3.l4.l5.l6.l7.l8.l9.l10.value = "deeper";
		assert(span.textContent === "deeper", `Update deep value: ${span.textContent}`);

		// Replace at level 5
		app.l1.l2.l3.l4.l5 = { l6: { l7: { l8: { l9: { l10: { value: "replaced" } } } } } };
		assert(span.textContent === "replaced", `Replace mid-level: ${span.textContent}`);
	});
	</script>

</body>
</html>
