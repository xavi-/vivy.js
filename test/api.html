<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<script src="../vivy.js"></script>
	<script src="./test_utils.js"></script>
	<style>
		.test-case { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
	</style>
</head>
<body>
	<h1>API & Edge Case Tests</h1>

	<!-- No-Op Mutation Test -->
	<div id="noop-test" class="test-case">
		<h3>1. Identical Value No-Op</h3>
		<span .text class.="$.attr"></span><span .vals[]></span>
	</div>
	<script>
	runTest("Identical Value No-Op", document.getElementById("noop-test"), async (el) => {
		const data = vivy(el, { text: "hello", attr: "okay", vals: [ 1, 2, 3 ] });

		// Observe for mutations
		let mutationCount = 0;
		const observer = new MutationObserver((mutations) => {
			mutationCount += mutations.length;
		});
		observer.observe(el, { childList: true, attributes: true, subtree: true });

		// Set identical values
		data.text = "hello";
		data.attr = "okay";

		data.vals[0] = 1;

		const tmp = data.vals;
		data.vals = tmp;

		await wait(1); // Wait for micro-tasks
		observer.disconnect();

		assert(mutationCount === 0, `Expected 0 mutations, got ${mutationCount}`);
	});
	</script>

	<!-- Error Handling -->
	<div id="error-test" class="test-case">
		<h3>2. API Error Handling</h3>
	</div>
	<script>
	runTest("Non-HTMLElement Argument", document.getElementById("error-test"), async () => {
		let errorMessage = "";
		try { vivy({}, {}); }
		catch(err) { errorMessage = err.message; }

		assert(errorMessage === "First vivy.js arg must be a HTMLElement", "Error message correct");
	});
	</script>

	<!-- Spread Copy -->
	<div id="spread-test" class="test-case">
		<h3>3. Proxy Spread Behavior</h3>
	</div>
	<script>
	runTest("Proxy Spread", document.getElementById("spread-test"), async () => {
		const div = document.createElement("div");
		const data = vivy(div, {});
		data.text = "hello";
		data.attr = "okay";
		data.vals = { a: 1, b: 2 };

		const copy = { ...data };

		assert(copy.text === "hello", "Copy text");
		assert(copy.attr === "okay", "Copy attr");
		assert(copy.vals.a === 1, "Copy vals.a");
		assert(copy.vals.b === 2, "Copy vals.b");
	});
	</script>

	<!-- Nulled Sub-Fields -->
	<div id="null-field-test" class="test-case">
		<h3>4. Nulled Sub-Fields</h3>
		<div id="null-container"><span .field.a.more></span></div>
	</div>
	<script>
	runTest("Nulled Sub-Fields", document.getElementById("null-field-test"), async (el) => {
		const data = vivy(el, { field: { a: { more: 1 }, b: 2 } });

		data.field = {};

		// data.field.a should be null/undefined
		assert(data.field.a == null, "Field.a should be null/undefined after parent reset");
	});
	</script>

	<!-- Proxy Reflection -->
	<div id="proxy-reflection-test" class="test-case">
		<h3>5. Proxy Reflection (ownKeys, has)</h3>
	</div>
	<script>
	runTest("Proxy Reflection", document.getElementById("proxy-reflection-test"), async () => {
		const div = document.createElement("div");
		const app = vivy(div, { a: 1, b: 2 });

		assert('a' in app, "'a' in app");
		assert(!('z' in app), "'z' not in app");

		const keys = Object.keys(app);
		assert(keys.includes('a') && keys.includes('b'), "Object.keys returns props");
		assert(keys.length === 2, "Object.keys length");

		const json = JSON.stringify(app);
		assert(json === '{"a":1,"b":2}', "JSON.stringify works");
	});
	</script>

	<!-- Delete Property -->
	<div id="delete-property-test" class="test-case">
		<h3>6. Delete Property</h3>
		<div .name></div>
		<div .age></div>
	</div>
	<script>
	runTest("Delete Property", document.getElementById("delete-property-test"), async (el) => {
		const app = vivy(el, { name: "John", age: 30 });

		const nameDiv = el.querySelector("div");
		const ageDiv = el.querySelectorAll("div")[1];

		assert(nameDiv.textContent === "John", "Init name");
		assert(ageDiv.textContent === "30", "Init age");

		delete app.name;
		assert(nameDiv.textContent === "", "Deleted property clears DOM");

		app.temp = "test";
		const result = delete app.temp;
		assert(result === true, "Delete returns true");
	});
	</script>

	<!-- Console Warnings - Near Miss -->
	<div id="warning-test" class="test-case">
		<h3>7. Console Warnings (Near Miss)</h3>
		<div .user-name></div>
	</div>
	<script>
	runTest("Console Warnings - Near Miss", document.getElementById("warning-test"), async () => {
		const warnings = [];
		const originalWarn = console.warn;
		console.warn = (...args) => warnings.push(args);

		try {
			const div2 = document.createElement("div");
			div2.innerHTML = "<span .username></span>";
			vivy(div2, { UserName: "Bob" });

			assert(warnings.some(w => w[0].includes("Near miss")), "Detects mixed-case mismatch");
		} finally {
			console.warn = originalWarn;
		}
	});
	</script>

	<!-- Vivify Alias -->
	<div id="vivify-test" class="test-case">
		<h3>8. Vivify Alias</h3>
		<div .message></div>
	</div>
	<script>
	runTest("Vivify Alias", document.getElementById("vivify-test"), async (el) => {
		assert(typeof vivify === "function", "vivify is a function");
		assert(vivify === vivy, "vivify === vivy");

		const app = vivify(el, { message: "Hello from vivify" });
		const div = el.querySelector("div");

		assert(div.textContent === "Hello from vivify", "vivify works correctly");

		app.message = "Updated via vivify";
		assert(div.textContent === "Updated via vivify", "vivify proxy updates work");
	});
	</script>

	<!-- Non-HTMLElement Error -->
	<div id="non-element-test" class="test-case">
		<h3>9. Non-HTMLElement Error</h3>
	</div>
	<script>
	runTest("Non-HTMLElement Error", document.getElementById("non-element-test"), async () => {
		let errorMessage = "";

		try {
			vivy(null, {});
		} catch (e) {
			errorMessage = e.message;
		}

		assert(errorMessage === "First vivy.js arg must be a HTMLElement", "Error text correct");

		try {
			vivy({}, {});
		} catch (e) {
			errorMessage = e.message;
		}
		assert(errorMessage === "First vivy.js arg must be a HTMLElement", "Error text correct");

		try {
			vivy("div", {});
		} catch (e) {
			errorMessage = e.message;
		}
		assert(errorMessage === "First vivy.js arg must be a HTMLElement", "Error text correct");
	});
	</script>

	<!-- Assign-to on Non-Input Warning -->
	<div id="assign-non-input-test" class="test-case">
		<h3>10. Assign-to on Non-Input Warning</h3>
		<div :assign-to="value"></div>
	</div>
	<script>
	runTest("Assign-to on Non-Input Warning", document.getElementById("assign-non-input-test"), async (el) => {
		const warnings = [];
		const originalWarn = console.warn;
		console.warn = (...args) => warnings.push(args);

		try {
			vivy(el, { value: "test" });

			assert(warnings.some(w => w[0].includes("non-input")), "Warns on assign-to non-input");
		} finally {
			console.warn = originalWarn;
		}
	});
	</script>

	<!-- Show-If Array Error -->
	<div id="show-if-array-error-test" class="test-case">
		<h3>11. Show-If Array Error</h3>
		<span .items[]?></span>
	</div>
	<script>
	runTest("Show-If Array Error", document.getElementById("show-if-array-error-test"), async (el) => {
		let errorMessage = "";

		try {
			vivy(el, { items: [1, 2, 3] });
		} catch (e) {
			errorMessage = e.message;
		}

		assert(errorMessage.startsWith("Can't show-if an array"), "Error text correct");
	});
	</script>

	<!-- Assign-to Array Error -->
	<div id="assign-to-array-error-test" class="test-case">
		<h3>12. Assign-to Array Error</h3>
		<input :assign-to="items[]">
	</div>
	<script>
	runTest("Assign-to Array Error", document.getElementById("assign-to-array-error-test"), async (el) => {
		let errorMessage = "";

		try {
			vivy(el, { items: [1, 2, 3] });
		} catch (e) {
			errorMessage = e.message;
		}

		assert(errorMessage.startsWith("Can't assign-to an array"), "Error text correct");
	});
	</script>

	<!-- Event Handler Path Array Error -->
	<div id="event-array-error-test" class="test-case">
		<h3>13. Event Handler Path Array Error</h3>
		<button @click='handlers[]'>Click</button>
	</div>
	<script>
	runTest("Event Handler Path Array Error", document.getElementById("event-array-error-test"), async (el) => {
		let errorMessage = "";

		try {
			vivy(el, { handlers: [() => {}] });
		} catch(e) {
			errorMessage = e.message;
		}

		assert(errorMessage.startsWith("Event handler path can't reference arrays"), "Error text correct");
	});
	</script>

	<!-- Proxy Root Update -->
	<div id="proxy-root-update-test" class="test-case">
		<h3>14. Proxy Root Update (Call as Function)</h3>
		<div .name></div>
		<div .count></div>
	</div>
	<script>
	runTest("Proxy Root Update", document.getElementById("proxy-root-update-test"), async (el) => {
		const app = vivy(el, { name: "Alice", count: 5 });

		const nameDiv = el.querySelector("div");
		const countDiv = el.querySelectorAll("div")[1];

		assert(nameDiv.textContent === "Alice", "Init name");
		assert(countDiv.textContent === "5", "Init count");

		app({ name: "Bob", count: 10 });

		assert(nameDiv.textContent === "Bob", "Root update name");
		assert(countDiv.textContent === "10", "Root update count");

		app({ name: "Charlie", count: 15, extra: "ignored" });
		assert(nameDiv.textContent === "Charlie", "Another root update");
	});
	</script>

	<!-- getOwnPropertyDescriptor -->
	<div id="property-descriptor-test" class="test-case">
		<h3>15. getOwnPropertyDescriptor Support</h3>
	</div>
	<script>
	runTest("getOwnPropertyDescriptor", document.getElementById("property-descriptor-test"), async () => {
		const div = document.createElement("div");
		const app = vivy(div, { name: "test", count: 42 });

		const desc = Object.getOwnPropertyDescriptor(app, "name");
		assert(desc !== undefined, "Descriptor exists");
		assert(desc.enumerable === true, "Property is enumerable");

		const noDesc = Object.getOwnPropertyDescriptor(app, "nonexistent");
		assert(noDesc === undefined, "No descriptor for missing prop");
	});
	</script>

	<!-- Duplicate Scope Warning -->
	<div id="duplicate-scope-test" class="test-case">
		<h3>16. Duplicate Scope Warning</h3>
		<div .first :scope=".second"></div>
	</div>
	<script>
	runTest("Duplicate Scope Warning", document.getElementById("duplicate-scope-test"), async (el) => {
		const warnings = [];
		const originalWarn = console.warn;
		console.warn = (...args) => warnings.push(args);

		try {
			vivy(el, { first: "a", second: "b" });

			assert(warnings.some(w => w[0].startsWith("Multiple scope paths found on element")), "Warns on duplicate scope");
		} finally {
			console.warn = originalWarn;
		}
	});
	</script>

	<!-- Scope Shadowing -->
	<div id="scope-shadowing-test" class="test-case">
		<h3>17. Scope Shadowing</h3>
		<div .user>
			<span class="outer-name" .name></span>
			<div .profile>
				<span class="inner-name" .name></span>
				<span class="root-name" $.user.name></span>
			</div>
		</div>
	</div>
	<script>
	runTest("Scope Shadowing", document.getElementById("scope-shadowing-test"), async (el) => {
		const app = vivy(el, {
			user: {
				name: "Outer",
				profile: {
					name: "Inner"
				}
			}
		});

		const outer = el.querySelector(".outer-name");
		const inner = el.querySelector(".inner-name");
		const root = el.querySelector(".root-name");

		assert(outer.textContent === "Outer", "Outer Name");
		assert(inner.textContent === "Inner", "Inner Name Shadowed");
		assert(root.textContent === "Outer", "Root Access Bypass Shadow");

		app.user.profile.name = "UPDATED";
		assert(inner.textContent === "UPDATED", "Update Shadowed");
		assert(outer.textContent === "Outer", "Outer Unchanged");
	});
	</script>

	<!-- Mixed Bindings and Scopes -->
	<div id="mixed-bindings-test" class="test-case">
		<h3>18. Mixed Bindings and Scopes</h3>
		<div .user title.="`User: ${_.name}`">
			<span .name></span>
		</div>
	</div>
	<script>
	runTest("Mixed Bindings and Scopes", document.getElementById("mixed-bindings-test"), async (el) => {
		const app = vivy(el, { user: { name: "Alice" } });
		const div = el.querySelector("div");
		const span = el.querySelector("span");

		assert(div.getAttribute("title") === "User: Alice", "Initial Title");
		assert(span.textContent === "Alice", "Initial Text");

		app.user.name = "Bob";
		assert(div.getAttribute("title") === "User: Bob", "Updated Title");
		assert(span.textContent === "Bob", "Updated Text");
	});
	</script>

	<!-- toParts Unit Tests -->
	<div id="to-parts-test" class="test-case">
		<h3>19. toParts Unit Tests</h3>
	</div>
	<script>
	runTest("toParts Unit Tests", document.getElementById("to-parts-test"), async () => {
		const toParts = vivy.toParts;

		assert(eq(toParts("key"), ["key"]), "Simple key");
		assert(eq(toParts("key.prop"), ["key","prop"]), "Simple path");

		assert(eq(toParts("a[]"), ["a", "[]"]), "a[]");
		assert(eq(toParts("[]a"), ["[]", "a"]), "[]a");
		assert(eq(toParts("items[]"), ["items","[]"]), "Array notation");
		assert(eq(toParts("items[].id"), ["items","[]","id"]), "Array notation with prop");

		assert(eq(toParts("$.root"), ["$","root"]), "Absolute path");
		assert(eq(toParts("$.nested.prop"), ["$","nested","prop"]), "Deep absolute path");

		assert(eq(toParts(""), []), "Empty string");
		assert(eq(toParts(".key"), ["key"]), "Leading dot");
		assert(eq(toParts("key."), ["key"]), "Trailing dot");
		assert(eq(toParts("..key"), ["key"]), "Double dot leading");
		assert(eq(toParts("a..b"), ["a","b"]), "Double dot middle");
		assert(eq(toParts("."), []), "Just dot");
		assert(eq(toParts("[]"), ["[]"]), "Just []");
		assert(eq(toParts("[][]"), ["[]","[]"]), "Adjacent brackets");
		assert(eq(toParts("$.[]"), ["$","[]"]), "Absolute array");
		assert(eq(toParts("..."), []), "Triple dot");
		assert(eq(toParts(".[]"), ["[]"]), "Top level []")
		assert(eq(toParts(".[.].[]"), ["[","]", "[]"]), "Partial [");
	});
	</script>

</body>
</html>
